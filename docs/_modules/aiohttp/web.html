
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>aiohttp.web &#8212; Teanga</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
    <link rel="canonical" href="http://pret-a-llod.github.io/teanga/_modules/aiohttp/web.html"/>
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for aiohttp.web</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="k">import</span> <span class="n">ArgumentParser</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="k">import</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="k">import</span> <span class="n">import_module</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">cast</span>

<span class="kn">from</span> <span class="nn">.abc</span> <span class="k">import</span> <span class="n">AbstractAccessLogger</span>
<span class="kn">from</span> <span class="nn">.helpers</span> <span class="k">import</span> <span class="n">all_tasks</span>
<span class="kn">from</span> <span class="nn">.log</span> <span class="k">import</span> <span class="n">access_logger</span>
<span class="kn">from</span> <span class="nn">.web_app</span> <span class="k">import</span> <span class="n">Application</span> <span class="k">as</span> <span class="n">Application</span>
<span class="kn">from</span> <span class="nn">.web_app</span> <span class="k">import</span> <span class="n">CleanupError</span> <span class="k">as</span> <span class="n">CleanupError</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPAccepted</span> <span class="k">as</span> <span class="n">HTTPAccepted</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPBadGateway</span> <span class="k">as</span> <span class="n">HTTPBadGateway</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPBadRequest</span> <span class="k">as</span> <span class="n">HTTPBadRequest</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPClientError</span> <span class="k">as</span> <span class="n">HTTPClientError</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPConflict</span> <span class="k">as</span> <span class="n">HTTPConflict</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPCreated</span> <span class="k">as</span> <span class="n">HTTPCreated</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPError</span> <span class="k">as</span> <span class="n">HTTPError</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPException</span> <span class="k">as</span> <span class="n">HTTPException</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPExpectationFailed</span> <span class="k">as</span> <span class="n">HTTPExpectationFailed</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPFailedDependency</span> <span class="k">as</span> <span class="n">HTTPFailedDependency</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPForbidden</span> <span class="k">as</span> <span class="n">HTTPForbidden</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPFound</span> <span class="k">as</span> <span class="n">HTTPFound</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPGatewayTimeout</span> <span class="k">as</span> <span class="n">HTTPGatewayTimeout</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPGone</span> <span class="k">as</span> <span class="n">HTTPGone</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPInsufficientStorage</span> <span class="k">as</span> <span class="n">HTTPInsufficientStorage</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPInternalServerError</span> <span class="k">as</span> <span class="n">HTTPInternalServerError</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPLengthRequired</span> <span class="k">as</span> <span class="n">HTTPLengthRequired</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPMethodNotAllowed</span> <span class="k">as</span> <span class="n">HTTPMethodNotAllowed</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPMisdirectedRequest</span> <span class="k">as</span> <span class="n">HTTPMisdirectedRequest</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPMovedPermanently</span> <span class="k">as</span> <span class="n">HTTPMovedPermanently</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPMultipleChoices</span> <span class="k">as</span> <span class="n">HTTPMultipleChoices</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">HTTPNetworkAuthenticationRequired</span> <span class="k">as</span> <span class="n">HTTPNetworkAuthenticationRequired</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPNoContent</span> <span class="k">as</span> <span class="n">HTTPNoContent</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">HTTPNonAuthoritativeInformation</span> <span class="k">as</span> <span class="n">HTTPNonAuthoritativeInformation</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPNotAcceptable</span> <span class="k">as</span> <span class="n">HTTPNotAcceptable</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPNotExtended</span> <span class="k">as</span> <span class="n">HTTPNotExtended</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPNotFound</span> <span class="k">as</span> <span class="n">HTTPNotFound</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPNotImplemented</span> <span class="k">as</span> <span class="n">HTTPNotImplemented</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPNotModified</span> <span class="k">as</span> <span class="n">HTTPNotModified</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPOk</span> <span class="k">as</span> <span class="n">HTTPOk</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPPartialContent</span> <span class="k">as</span> <span class="n">HTTPPartialContent</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPPaymentRequired</span> <span class="k">as</span> <span class="n">HTTPPaymentRequired</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPPermanentRedirect</span> <span class="k">as</span> <span class="n">HTTPPermanentRedirect</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPPreconditionFailed</span> <span class="k">as</span> <span class="n">HTTPPreconditionFailed</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">HTTPPreconditionRequired</span> <span class="k">as</span> <span class="n">HTTPPreconditionRequired</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">HTTPProxyAuthenticationRequired</span> <span class="k">as</span> <span class="n">HTTPProxyAuthenticationRequired</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPRedirection</span> <span class="k">as</span> <span class="n">HTTPRedirection</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">HTTPRequestEntityTooLarge</span> <span class="k">as</span> <span class="n">HTTPRequestEntityTooLarge</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">HTTPRequestHeaderFieldsTooLarge</span> <span class="k">as</span> <span class="n">HTTPRequestHeaderFieldsTooLarge</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">HTTPRequestRangeNotSatisfiable</span> <span class="k">as</span> <span class="n">HTTPRequestRangeNotSatisfiable</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPRequestTimeout</span> <span class="k">as</span> <span class="n">HTTPRequestTimeout</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPRequestURITooLong</span> <span class="k">as</span> <span class="n">HTTPRequestURITooLong</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPResetContent</span> <span class="k">as</span> <span class="n">HTTPResetContent</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPSeeOther</span> <span class="k">as</span> <span class="n">HTTPSeeOther</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPServerError</span> <span class="k">as</span> <span class="n">HTTPServerError</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPServiceUnavailable</span> <span class="k">as</span> <span class="n">HTTPServiceUnavailable</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPSuccessful</span> <span class="k">as</span> <span class="n">HTTPSuccessful</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPTemporaryRedirect</span> <span class="k">as</span> <span class="n">HTTPTemporaryRedirect</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPTooManyRequests</span> <span class="k">as</span> <span class="n">HTTPTooManyRequests</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPUnauthorized</span> <span class="k">as</span> <span class="n">HTTPUnauthorized</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">HTTPUnavailableForLegalReasons</span> <span class="k">as</span> <span class="n">HTTPUnavailableForLegalReasons</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPUnprocessableEntity</span> <span class="k">as</span> <span class="n">HTTPUnprocessableEntity</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">HTTPUnsupportedMediaType</span> <span class="k">as</span> <span class="n">HTTPUnsupportedMediaType</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPUpgradeRequired</span> <span class="k">as</span> <span class="n">HTTPUpgradeRequired</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPUseProxy</span> <span class="k">as</span> <span class="n">HTTPUseProxy</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">HTTPVariantAlsoNegotiates</span> <span class="k">as</span> <span class="n">HTTPVariantAlsoNegotiates</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.web_exceptions</span> <span class="k">import</span> <span class="n">HTTPVersionNotSupported</span> <span class="k">as</span> <span class="n">HTTPVersionNotSupported</span>
<span class="kn">from</span> <span class="nn">.web_fileresponse</span> <span class="k">import</span> <span class="n">FileResponse</span> <span class="k">as</span> <span class="n">FileResponse</span>
<span class="kn">from</span> <span class="nn">.web_log</span> <span class="k">import</span> <span class="n">AccessLogger</span>
<span class="kn">from</span> <span class="nn">.web_middlewares</span> <span class="k">import</span> <span class="n">middleware</span> <span class="k">as</span> <span class="n">middleware</span>
<span class="kn">from</span> <span class="nn">.web_middlewares</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">normalize_path_middleware</span> <span class="k">as</span> <span class="n">normalize_path_middleware</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.web_protocol</span> <span class="k">import</span> <span class="n">PayloadAccessError</span> <span class="k">as</span> <span class="n">PayloadAccessError</span>
<span class="kn">from</span> <span class="nn">.web_protocol</span> <span class="k">import</span> <span class="n">RequestHandler</span> <span class="k">as</span> <span class="n">RequestHandler</span>
<span class="kn">from</span> <span class="nn">.web_protocol</span> <span class="k">import</span> <span class="n">RequestPayloadError</span> <span class="k">as</span> <span class="n">RequestPayloadError</span>
<span class="kn">from</span> <span class="nn">.web_request</span> <span class="k">import</span> <span class="n">BaseRequest</span> <span class="k">as</span> <span class="n">BaseRequest</span>
<span class="kn">from</span> <span class="nn">.web_request</span> <span class="k">import</span> <span class="n">FileField</span> <span class="k">as</span> <span class="n">FileField</span>
<span class="kn">from</span> <span class="nn">.web_request</span> <span class="k">import</span> <span class="n">Request</span> <span class="k">as</span> <span class="n">Request</span>
<span class="kn">from</span> <span class="nn">.web_response</span> <span class="k">import</span> <span class="n">ContentCoding</span> <span class="k">as</span> <span class="n">ContentCoding</span>
<span class="kn">from</span> <span class="nn">.web_response</span> <span class="k">import</span> <span class="n">Response</span> <span class="k">as</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">.web_response</span> <span class="k">import</span> <span class="n">StreamResponse</span> <span class="k">as</span> <span class="n">StreamResponse</span>
<span class="kn">from</span> <span class="nn">.web_response</span> <span class="k">import</span> <span class="n">json_response</span> <span class="k">as</span> <span class="n">json_response</span>
<span class="kn">from</span> <span class="nn">.web_routedef</span> <span class="k">import</span> <span class="n">AbstractRouteDef</span> <span class="k">as</span> <span class="n">AbstractRouteDef</span>
<span class="kn">from</span> <span class="nn">.web_routedef</span> <span class="k">import</span> <span class="n">RouteDef</span> <span class="k">as</span> <span class="n">RouteDef</span>
<span class="kn">from</span> <span class="nn">.web_routedef</span> <span class="k">import</span> <span class="n">RouteTableDef</span> <span class="k">as</span> <span class="n">RouteTableDef</span>
<span class="kn">from</span> <span class="nn">.web_routedef</span> <span class="k">import</span> <span class="n">StaticDef</span> <span class="k">as</span> <span class="n">StaticDef</span>
<span class="kn">from</span> <span class="nn">.web_routedef</span> <span class="k">import</span> <span class="n">delete</span> <span class="k">as</span> <span class="n">delete</span>
<span class="kn">from</span> <span class="nn">.web_routedef</span> <span class="k">import</span> <span class="n">get</span> <span class="k">as</span> <span class="n">get</span>
<span class="kn">from</span> <span class="nn">.web_routedef</span> <span class="k">import</span> <span class="n">head</span> <span class="k">as</span> <span class="n">head</span>
<span class="kn">from</span> <span class="nn">.web_routedef</span> <span class="k">import</span> <span class="n">options</span> <span class="k">as</span> <span class="n">options</span>
<span class="kn">from</span> <span class="nn">.web_routedef</span> <span class="k">import</span> <span class="n">patch</span> <span class="k">as</span> <span class="n">patch</span>
<span class="kn">from</span> <span class="nn">.web_routedef</span> <span class="k">import</span> <span class="n">post</span> <span class="k">as</span> <span class="n">post</span>
<span class="kn">from</span> <span class="nn">.web_routedef</span> <span class="k">import</span> <span class="n">put</span> <span class="k">as</span> <span class="n">put</span>
<span class="kn">from</span> <span class="nn">.web_routedef</span> <span class="k">import</span> <span class="n">route</span> <span class="k">as</span> <span class="n">route</span>
<span class="kn">from</span> <span class="nn">.web_routedef</span> <span class="k">import</span> <span class="n">static</span> <span class="k">as</span> <span class="n">static</span>
<span class="kn">from</span> <span class="nn">.web_routedef</span> <span class="k">import</span> <span class="n">view</span> <span class="k">as</span> <span class="n">view</span>
<span class="kn">from</span> <span class="nn">.web_runner</span> <span class="k">import</span> <span class="n">AppRunner</span> <span class="k">as</span> <span class="n">AppRunner</span>
<span class="kn">from</span> <span class="nn">.web_runner</span> <span class="k">import</span> <span class="n">BaseRunner</span> <span class="k">as</span> <span class="n">BaseRunner</span>
<span class="kn">from</span> <span class="nn">.web_runner</span> <span class="k">import</span> <span class="n">BaseSite</span> <span class="k">as</span> <span class="n">BaseSite</span>
<span class="kn">from</span> <span class="nn">.web_runner</span> <span class="k">import</span> <span class="n">GracefulExit</span> <span class="k">as</span> <span class="n">GracefulExit</span>
<span class="kn">from</span> <span class="nn">.web_runner</span> <span class="k">import</span> <span class="n">NamedPipeSite</span> <span class="k">as</span> <span class="n">NamedPipeSite</span>
<span class="kn">from</span> <span class="nn">.web_runner</span> <span class="k">import</span> <span class="n">ServerRunner</span> <span class="k">as</span> <span class="n">ServerRunner</span>
<span class="kn">from</span> <span class="nn">.web_runner</span> <span class="k">import</span> <span class="n">SockSite</span> <span class="k">as</span> <span class="n">SockSite</span>
<span class="kn">from</span> <span class="nn">.web_runner</span> <span class="k">import</span> <span class="n">TCPSite</span> <span class="k">as</span> <span class="n">TCPSite</span>
<span class="kn">from</span> <span class="nn">.web_runner</span> <span class="k">import</span> <span class="n">UnixSite</span> <span class="k">as</span> <span class="n">UnixSite</span>
<span class="kn">from</span> <span class="nn">.web_server</span> <span class="k">import</span> <span class="n">Server</span> <span class="k">as</span> <span class="n">Server</span>
<span class="kn">from</span> <span class="nn">.web_urldispatcher</span> <span class="k">import</span> <span class="n">AbstractResource</span> <span class="k">as</span> <span class="n">AbstractResource</span>
<span class="kn">from</span> <span class="nn">.web_urldispatcher</span> <span class="k">import</span> <span class="n">AbstractRoute</span> <span class="k">as</span> <span class="n">AbstractRoute</span>
<span class="kn">from</span> <span class="nn">.web_urldispatcher</span> <span class="k">import</span> <span class="n">DynamicResource</span> <span class="k">as</span> <span class="n">DynamicResource</span>
<span class="kn">from</span> <span class="nn">.web_urldispatcher</span> <span class="k">import</span> <span class="n">PlainResource</span> <span class="k">as</span> <span class="n">PlainResource</span>
<span class="kn">from</span> <span class="nn">.web_urldispatcher</span> <span class="k">import</span> <span class="n">Resource</span> <span class="k">as</span> <span class="n">Resource</span>
<span class="kn">from</span> <span class="nn">.web_urldispatcher</span> <span class="k">import</span> <span class="n">ResourceRoute</span> <span class="k">as</span> <span class="n">ResourceRoute</span>
<span class="kn">from</span> <span class="nn">.web_urldispatcher</span> <span class="k">import</span> <span class="n">StaticResource</span> <span class="k">as</span> <span class="n">StaticResource</span>
<span class="kn">from</span> <span class="nn">.web_urldispatcher</span> <span class="k">import</span> <span class="n">UrlDispatcher</span> <span class="k">as</span> <span class="n">UrlDispatcher</span>
<span class="kn">from</span> <span class="nn">.web_urldispatcher</span> <span class="k">import</span> <span class="n">UrlMappingMatchInfo</span> <span class="k">as</span> <span class="n">UrlMappingMatchInfo</span>
<span class="kn">from</span> <span class="nn">.web_urldispatcher</span> <span class="k">import</span> <span class="n">View</span> <span class="k">as</span> <span class="n">View</span>
<span class="kn">from</span> <span class="nn">.web_ws</span> <span class="k">import</span> <span class="n">WebSocketReady</span> <span class="k">as</span> <span class="n">WebSocketReady</span>
<span class="kn">from</span> <span class="nn">.web_ws</span> <span class="k">import</span> <span class="n">WebSocketResponse</span> <span class="k">as</span> <span class="n">WebSocketResponse</span>
<span class="kn">from</span> <span class="nn">.web_ws</span> <span class="k">import</span> <span class="n">WSMsgType</span> <span class="k">as</span> <span class="n">WSMsgType</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span>
    <span class="c1"># web_app</span>
    <span class="s1">&#39;Application&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CleanupError&#39;</span><span class="p">,</span>
    <span class="c1"># web_exceptions</span>
    <span class="s1">&#39;HTTPAccepted&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPBadGateway&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPBadRequest&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPClientError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPConflict&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPCreated&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPException&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPExpectationFailed&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPFailedDependency&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPForbidden&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPFound&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPGatewayTimeout&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPGone&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPInsufficientStorage&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPInternalServerError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPLengthRequired&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPMethodNotAllowed&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPMisdirectedRequest&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPMovedPermanently&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPMultipleChoices&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPNetworkAuthenticationRequired&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPNoContent&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPNonAuthoritativeInformation&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPNotAcceptable&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPNotExtended&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPNotFound&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPNotImplemented&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPNotModified&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPOk&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPPartialContent&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPPaymentRequired&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPPermanentRedirect&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPPreconditionFailed&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPPreconditionRequired&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPProxyAuthenticationRequired&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPRedirection&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPRequestEntityTooLarge&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPRequestHeaderFieldsTooLarge&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPRequestRangeNotSatisfiable&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPRequestTimeout&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPRequestURITooLong&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPResetContent&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPSeeOther&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPServerError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPServiceUnavailable&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPSuccessful&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPTemporaryRedirect&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPTooManyRequests&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPUnauthorized&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPUnavailableForLegalReasons&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPUnprocessableEntity&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPUnsupportedMediaType&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPUpgradeRequired&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPUseProxy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPVariantAlsoNegotiates&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPVersionNotSupported&#39;</span><span class="p">,</span>
    <span class="c1"># web_fileresponse</span>
    <span class="s1">&#39;FileResponse&#39;</span><span class="p">,</span>
    <span class="c1"># web_middlewares</span>
    <span class="s1">&#39;middleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;normalize_path_middleware&#39;</span><span class="p">,</span>
    <span class="c1"># web_protocol</span>
    <span class="s1">&#39;PayloadAccessError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;RequestHandler&#39;</span><span class="p">,</span>
    <span class="s1">&#39;RequestPayloadError&#39;</span><span class="p">,</span>
    <span class="c1"># web_request</span>
    <span class="s1">&#39;BaseRequest&#39;</span><span class="p">,</span>
    <span class="s1">&#39;FileField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Request&#39;</span><span class="p">,</span>
    <span class="c1"># web_response</span>
    <span class="s1">&#39;ContentCoding&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Response&#39;</span><span class="p">,</span>
    <span class="s1">&#39;StreamResponse&#39;</span><span class="p">,</span>
    <span class="s1">&#39;json_response&#39;</span><span class="p">,</span>
    <span class="c1"># web_routedef</span>
    <span class="s1">&#39;AbstractRouteDef&#39;</span><span class="p">,</span>
    <span class="s1">&#39;RouteDef&#39;</span><span class="p">,</span>
    <span class="s1">&#39;RouteTableDef&#39;</span><span class="p">,</span>
    <span class="s1">&#39;StaticDef&#39;</span><span class="p">,</span>
    <span class="s1">&#39;delete&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get&#39;</span><span class="p">,</span>
    <span class="s1">&#39;head&#39;</span><span class="p">,</span>
    <span class="s1">&#39;options&#39;</span><span class="p">,</span>
    <span class="s1">&#39;patch&#39;</span><span class="p">,</span>
    <span class="s1">&#39;post&#39;</span><span class="p">,</span>
    <span class="s1">&#39;put&#39;</span><span class="p">,</span>
    <span class="s1">&#39;route&#39;</span><span class="p">,</span>
    <span class="s1">&#39;static&#39;</span><span class="p">,</span>
    <span class="s1">&#39;view&#39;</span><span class="p">,</span>
    <span class="c1"># web_runner</span>
    <span class="s1">&#39;AppRunner&#39;</span><span class="p">,</span>
    <span class="s1">&#39;BaseRunner&#39;</span><span class="p">,</span>
    <span class="s1">&#39;BaseSite&#39;</span><span class="p">,</span>
    <span class="s1">&#39;GracefulExit&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ServerRunner&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SockSite&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TCPSite&#39;</span><span class="p">,</span>
    <span class="s1">&#39;UnixSite&#39;</span><span class="p">,</span>
    <span class="s1">&#39;NamedPipeSite&#39;</span><span class="p">,</span>
    <span class="c1"># web_server</span>
    <span class="s1">&#39;Server&#39;</span><span class="p">,</span>
    <span class="c1"># web_urldispatcher</span>
    <span class="s1">&#39;AbstractResource&#39;</span><span class="p">,</span>
    <span class="s1">&#39;AbstractRoute&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DynamicResource&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PlainResource&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Resource&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ResourceRoute&#39;</span><span class="p">,</span>
    <span class="s1">&#39;StaticResource&#39;</span><span class="p">,</span>
    <span class="s1">&#39;UrlDispatcher&#39;</span><span class="p">,</span>
    <span class="s1">&#39;UrlMappingMatchInfo&#39;</span><span class="p">,</span>
    <span class="s1">&#39;View&#39;</span><span class="p">,</span>
    <span class="c1"># web_ws</span>
    <span class="s1">&#39;WebSocketReady&#39;</span><span class="p">,</span>
    <span class="s1">&#39;WebSocketResponse&#39;</span><span class="p">,</span>
    <span class="s1">&#39;WSMsgType&#39;</span><span class="p">,</span>
    <span class="c1"># web</span>
    <span class="s1">&#39;run_app&#39;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">ssl</span> <span class="k">import</span> <span class="n">SSLContext</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="n">SSLContext</span> <span class="o">=</span> <span class="n">Any</span>  <span class="c1"># type: ignore</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">_run_app</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Application</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Application</span><span class="p">]],</span> <span class="o">*</span><span class="p">,</span>
                   <span class="n">host</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">sock</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">shutdown_timeout</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">60.0</span><span class="p">,</span>
                   <span class="n">ssl_context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SSLContext</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="nb">print</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="nb">print</span><span class="p">,</span>
                   <span class="n">backlog</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
                   <span class="n">access_log_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">AbstractAccessLogger</span><span class="p">]</span><span class="o">=</span><span class="n">AccessLogger</span><span class="p">,</span>
                   <span class="n">access_log_format</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="n">AccessLogger</span><span class="o">.</span><span class="n">LOG_FORMAT</span><span class="p">,</span>
                   <span class="n">access_log</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">]</span><span class="o">=</span><span class="n">access_logger</span><span class="p">,</span>
                   <span class="n">handle_signals</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">reuse_address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">reuse_port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># A internal functio to actually do all dirty job for application running</span>
    <span class="k">if</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">iscoroutine</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
        <span class="n">app</span> <span class="o">=</span> <span class="k">await</span> <span class="n">app</span>  <span class="c1"># type: ignore</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Application</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>

    <span class="n">runner</span> <span class="o">=</span> <span class="n">AppRunner</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">handle_signals</span><span class="o">=</span><span class="n">handle_signals</span><span class="p">,</span>
                       <span class="n">access_log_class</span><span class="o">=</span><span class="n">access_log_class</span><span class="p">,</span>
                       <span class="n">access_log_format</span><span class="o">=</span><span class="n">access_log_format</span><span class="p">,</span>
                       <span class="n">access_log</span><span class="o">=</span><span class="n">access_log</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">runner</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

    <span class="n">sites</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[BaseSite]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">host</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">,</span> <span class="nb">memoryview</span><span class="p">)):</span>
                <span class="n">sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TCPSite</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
                                     <span class="n">shutdown_timeout</span><span class="o">=</span><span class="n">shutdown_timeout</span><span class="p">,</span>
                                     <span class="n">ssl_context</span><span class="o">=</span><span class="n">ssl_context</span><span class="p">,</span>
                                     <span class="n">backlog</span><span class="o">=</span><span class="n">backlog</span><span class="p">,</span>
                                     <span class="n">reuse_address</span><span class="o">=</span><span class="n">reuse_address</span><span class="p">,</span>
                                     <span class="n">reuse_port</span><span class="o">=</span><span class="n">reuse_port</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">host</span><span class="p">:</span>
                    <span class="n">sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TCPSite</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
                                         <span class="n">shutdown_timeout</span><span class="o">=</span><span class="n">shutdown_timeout</span><span class="p">,</span>
                                         <span class="n">ssl_context</span><span class="o">=</span><span class="n">ssl_context</span><span class="p">,</span>
                                         <span class="n">backlog</span><span class="o">=</span><span class="n">backlog</span><span class="p">,</span>
                                         <span class="n">reuse_address</span><span class="o">=</span><span class="n">reuse_address</span><span class="p">,</span>
                                         <span class="n">reuse_port</span><span class="o">=</span><span class="n">reuse_port</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sock</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">port</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TCPSite</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span>
                                 <span class="n">shutdown_timeout</span><span class="o">=</span><span class="n">shutdown_timeout</span><span class="p">,</span>
                                 <span class="n">ssl_context</span><span class="o">=</span><span class="n">ssl_context</span><span class="p">,</span> <span class="n">backlog</span><span class="o">=</span><span class="n">backlog</span><span class="p">,</span>
                                 <span class="n">reuse_address</span><span class="o">=</span><span class="n">reuse_address</span><span class="p">,</span>
                                 <span class="n">reuse_port</span><span class="o">=</span><span class="n">reuse_port</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">,</span> <span class="nb">memoryview</span><span class="p">)):</span>
                <span class="n">sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UnixSite</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span>
                                      <span class="n">shutdown_timeout</span><span class="o">=</span><span class="n">shutdown_timeout</span><span class="p">,</span>
                                      <span class="n">ssl_context</span><span class="o">=</span><span class="n">ssl_context</span><span class="p">,</span>
                                      <span class="n">backlog</span><span class="o">=</span><span class="n">backlog</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                    <span class="n">sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UnixSite</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span>
                                          <span class="n">shutdown_timeout</span><span class="o">=</span><span class="n">shutdown_timeout</span><span class="p">,</span>
                                          <span class="n">ssl_context</span><span class="o">=</span><span class="n">ssl_context</span><span class="p">,</span>
                                          <span class="n">backlog</span><span class="o">=</span><span class="n">backlog</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">sock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
                <span class="n">sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SockSite</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span>
                                      <span class="n">shutdown_timeout</span><span class="o">=</span><span class="n">shutdown_timeout</span><span class="p">,</span>
                                      <span class="n">ssl_context</span><span class="o">=</span><span class="n">ssl_context</span><span class="p">,</span>
                                      <span class="n">backlog</span><span class="o">=</span><span class="n">backlog</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sock</span><span class="p">:</span>
                    <span class="n">sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SockSite</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
                                          <span class="n">shutdown_timeout</span><span class="o">=</span><span class="n">shutdown_timeout</span><span class="p">,</span>
                                          <span class="n">ssl_context</span><span class="o">=</span><span class="n">ssl_context</span><span class="p">,</span>
                                          <span class="n">backlog</span><span class="o">=</span><span class="n">backlog</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">site</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">print</span><span class="p">:</span>  <span class="c1"># pragma: no branch</span>
            <span class="n">names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">sites</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;======== Running on </span><span class="si">{}</span><span class="s2"> ========</span><span class="se">\n</span><span class="s2">&quot;</span>
                  <span class="s2">&quot;(Press CTRL+C to quit)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">)))</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3600</span><span class="p">)</span>  <span class="c1"># sleep forever by 1 hour intervals</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">runner</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_cancel_all_tasks</span><span class="p">(</span><span class="n">loop</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">to_cancel</span> <span class="o">=</span> <span class="n">all_tasks</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">to_cancel</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">to_cancel</span><span class="p">:</span>
        <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">to_cancel</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">to_cancel</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">cancelled</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">exception</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loop</span><span class="o">.</span><span class="n">call_exception_handler</span><span class="p">({</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;unhandled exception during asyncio.run() shutdown&#39;</span><span class="p">,</span>
                <span class="s1">&#39;exception&#39;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">exception</span><span class="p">(),</span>
                <span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">task</span><span class="p">,</span>
            <span class="p">})</span>


<div class="viewcode-block" id="run_app"><a class="viewcode-back" href="../../web_reference.html#aiohttp.web.run_app">[docs]</a><span class="k">def</span> <span class="nf">run_app</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Application</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Application</span><span class="p">]],</span> <span class="o">*</span><span class="p">,</span>
            <span class="n">host</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">sock</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">shutdown_timeout</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">60.0</span><span class="p">,</span>
            <span class="n">ssl_context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SSLContext</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="nb">print</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="nb">print</span><span class="p">,</span>
            <span class="n">backlog</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
            <span class="n">access_log_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">AbstractAccessLogger</span><span class="p">]</span><span class="o">=</span><span class="n">AccessLogger</span><span class="p">,</span>
            <span class="n">access_log_format</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="n">AccessLogger</span><span class="o">.</span><span class="n">LOG_FORMAT</span><span class="p">,</span>
            <span class="n">access_log</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">]</span><span class="o">=</span><span class="n">access_logger</span><span class="p">,</span>
            <span class="n">handle_signals</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">reuse_address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">reuse_port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Run an app locally&quot;&quot;&quot;</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>

    <span class="c1"># Configure if and only if in debugging mode and using the default logger</span>
    <span class="k">if</span> <span class="n">loop</span><span class="o">.</span><span class="n">get_debug</span><span class="p">()</span> <span class="ow">and</span> <span class="n">access_log</span> <span class="ow">and</span> <span class="n">access_log</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;aiohttp.access&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">access_log</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">:</span>
            <span class="n">access_log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">access_log</span><span class="o">.</span><span class="n">hasHandlers</span><span class="p">():</span>
            <span class="n">access_log</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">())</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">_run_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span>
                                         <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
                                         <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span>
                                         <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
                                         <span class="n">sock</span><span class="o">=</span><span class="n">sock</span><span class="p">,</span>
                                         <span class="n">shutdown_timeout</span><span class="o">=</span><span class="n">shutdown_timeout</span><span class="p">,</span>
                                         <span class="n">ssl_context</span><span class="o">=</span><span class="n">ssl_context</span><span class="p">,</span>
                                         <span class="nb">print</span><span class="o">=</span><span class="nb">print</span><span class="p">,</span>
                                         <span class="n">backlog</span><span class="o">=</span><span class="n">backlog</span><span class="p">,</span>
                                         <span class="n">access_log_class</span><span class="o">=</span><span class="n">access_log_class</span><span class="p">,</span>
                                         <span class="n">access_log_format</span><span class="o">=</span><span class="n">access_log_format</span><span class="p">,</span>
                                         <span class="n">access_log</span><span class="o">=</span><span class="n">access_log</span><span class="p">,</span>
                                         <span class="n">handle_signals</span><span class="o">=</span><span class="n">handle_signals</span><span class="p">,</span>
                                         <span class="n">reuse_address</span><span class="o">=</span><span class="n">reuse_address</span><span class="p">,</span>
                                         <span class="n">reuse_port</span><span class="o">=</span><span class="n">reuse_port</span><span class="p">))</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">GracefulExit</span><span class="p">,</span> <span class="ne">KeyboardInterrupt</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="k">pass</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">_cancel_all_tasks</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>  <span class="c1"># don&#39;t use PY_36 to pass mypy</span>
            <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">shutdown_asyncgens</span><span class="p">())</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">arg_parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;aiohttp.web Application server&quot;</span><span class="p">,</span>
        <span class="n">prog</span><span class="o">=</span><span class="s2">&quot;aiohttp.web&quot;</span>
    <span class="p">)</span>
    <span class="n">arg_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;entry_func&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Callable returning the `aiohttp.web.Application` instance to &quot;</span>
              <span class="s2">&quot;run. Should be specified in the &#39;module:function&#39; syntax.&quot;</span><span class="p">),</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;entry-func&quot;</span>
    <span class="p">)</span>
    <span class="n">arg_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-H&quot;</span><span class="p">,</span> <span class="s2">&quot;--hostname&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;TCP/IP hostname to serve on (default: </span><span class="si">%(default)r</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span>
    <span class="p">)</span>
    <span class="n">arg_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-P&quot;</span><span class="p">,</span> <span class="s2">&quot;--port&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;TCP/IP port to serve on (default: </span><span class="si">%(default)r</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;8080&quot;</span>
    <span class="p">)</span>
    <span class="n">arg_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-U&quot;</span><span class="p">,</span> <span class="s2">&quot;--path&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Unix file system path to serve on. Specifying a path will cause &quot;</span>
             <span class="s2">&quot;hostname and port arguments to be ignored.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">args</span><span class="p">,</span> <span class="n">extra_argv</span> <span class="o">=</span> <span class="n">arg_parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>

    <span class="c1"># Import logic</span>
    <span class="n">mod_str</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">func_str</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">entry_func</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">func_str</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">mod_str</span><span class="p">:</span>
        <span class="n">arg_parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;&#39;entry-func&#39; not in &#39;module:function&#39; syntax&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">mod_str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
        <span class="n">arg_parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;relative module names not supported&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="n">mod_str</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">arg_parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;unable to import </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mod_str</span><span class="p">,</span> <span class="n">ex</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">func_str</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">arg_parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;module </span><span class="si">%r</span><span class="s2"> has no attribute </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mod_str</span><span class="p">,</span> <span class="n">func_str</span><span class="p">))</span>

    <span class="c1"># Compatibility logic</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s1">&#39;AF_UNIX&#39;</span><span class="p">):</span>
        <span class="n">arg_parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;file system paths not supported by your operating&quot;</span>
                         <span class="s2">&quot; environment&quot;</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">extra_argv</span><span class="p">)</span>
    <span class="n">run_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
    <span class="n">arg_parser</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Stopped</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>  <span class="c1"># pragma: no branch</span>
    <span class="n">main</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>  <span class="c1"># pragma: no cover</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/teanga-logo.svg" alt="Logo"/>
    
  </a>
</p>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=pret-a-llod&repo=teanga&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../create_workflow.html">How to create a workflow in Teanga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../create_service.html">How to create a service in Teanga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../run_workflow.html">How to run a workflow in Teanga</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, teanga maintainers.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    
    <a href="https://github.com/pret-a-llod/teanga" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>