
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Web Server Advanced &#8212; Teanga</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
    <link rel="canonical" href="http://pret-a-llod.github.io/teanga/web_advanced.html"/>
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="web-server-advanced">
<span id="aiohttp-web-advanced"></span><h1>Web Server Advanced<a class="headerlink" href="#web-server-advanced" title="Permalink to this headline">¶</a></h1>
<div class="section" id="unicode-support">
<h2>Unicode support<a class="headerlink" href="#unicode-support" title="Permalink to this headline">¶</a></h2>
<p><em>aiohttp</em> does <a class="reference internal" href="glossary.html#term-requoting"><span class="xref std std-term">requoting</span></a> of incoming request path.</p>
<p>Unicode (non-ASCII) symbols are processed transparently on both <em>route
adding</em> and <em>resolving</em> (internally everything is converted to
<a class="reference internal" href="glossary.html#term-percent-encoding"><span class="xref std std-term">percent-encoding</span></a> form by <a class="reference internal" href="glossary.html#term-yarl"><span class="xref std std-term">yarl</span></a> library).</p>
<p>But in case of custom regular expressions for
<a class="reference internal" href="web_quickstart.html#aiohttp-web-variable-handler"><span class="std std-ref">Variable Resources</span></a> please take care that URL is
<em>percent encoded</em>: if you pass Unicode patterns they don’t match to
<em>requoted</em> path.</p>
</div>
<div class="section" id="peer-disconnection">
<h2>Peer disconnection<a class="headerlink" href="#peer-disconnection" title="Permalink to this headline">¶</a></h2>
<p>When a client peer is gone a subsequent reading or writing raises <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#OSError" title="(in Python v3.8)"><code class="xref py py-exc docutils literal notranslate"><span class="pre">OSError</span></code></a>
or more specific exception like <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#ConnectionResetError" title="(in Python v3.8)"><code class="xref py py-exc docutils literal notranslate"><span class="pre">ConnectionResetError</span></code></a>.</p>
<p>The reason for disconnection is vary; it can be a network issue or explicit
socket closing on the peer side without reading the whole server response.</p>
<p><em>aiohttp</em> handles disconnection properly but you can handle it explicitly, e.g.:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="c1"># disconnected</span>
</pre></div>
</div>
</div>
<div class="section" id="passing-a-coroutine-into-run-app-and-gunicorn">
<h2>Passing a coroutine into run_app and Gunicorn<a class="headerlink" href="#passing-a-coroutine-into-run-app-and-gunicorn" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="web_reference.html#aiohttp.web.run_app" title="aiohttp.web.run_app"><code class="xref py py-func docutils literal notranslate"><span class="pre">run_app()</span></code></a> accepts either application instance or a coroutine for
making an application. The coroutine based approach allows to perform
async IO before making an app:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">app_factory</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">pre_init</span><span class="p">()</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">()</span>
    <span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_get</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">app</span>

<span class="n">web</span><span class="o">.</span><span class="n">run_app</span><span class="p">(</span><span class="n">app_factory</span><span class="p">())</span>
</pre></div>
</div>
<p>Gunicorn worker supports a factory as well. For Gunicorn the factory
should accept zero parameters:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">my_web_app</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">()</span>
    <span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_get</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">app</span>
</pre></div>
</div>
<p>Start gunicorn:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ gunicorn my_app_module:my_web_app --bind localhost:8080 --worker-class aiohttp.GunicornWebWorker
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 3.1.</span></p>
</div>
</div>
<div class="section" id="custom-routing-criteria">
<h2>Custom Routing Criteria<a class="headerlink" href="#custom-routing-criteria" title="Permalink to this headline">¶</a></h2>
<p>Sometimes you need to register <a class="reference internal" href="web_quickstart.html#aiohttp-web-handler"><span class="std std-ref">handlers</span></a> on
more complex criteria than simply a <em>HTTP method</em> and <em>path</em> pair.</p>
<p>Although <a class="reference internal" href="web_reference.html#aiohttp.web.UrlDispatcher" title="aiohttp.web.UrlDispatcher"><code class="xref py py-class docutils literal notranslate"><span class="pre">UrlDispatcher</span></code></a> does not support any extra criteria, routing
based on custom conditions can be accomplished by implementing a second layer
of routing in your application.</p>
<p>The following example shows custom routing based on the <em>HTTP Accept</em> header:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AcceptChooser</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_accepts</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">do_route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">accept</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">getall</span><span class="p">(</span><span class="s1">&#39;ACCEPT&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">acceptor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accepts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">accept</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">acceptor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="k">await</span> <span class="n">acceptor</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">HTTPNotAcceptable</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reg_acceptor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accept</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_accepts</span><span class="p">[</span><span class="n">accept</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_json</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># do json handling</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_xml</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># do xml handling</span>

<span class="n">chooser</span> <span class="o">=</span> <span class="n">AcceptChooser</span><span class="p">()</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_routes</span><span class="p">([</span><span class="n">web</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">chooser</span><span class="o">.</span><span class="n">do_route</span><span class="p">)])</span>

<span class="n">chooser</span><span class="o">.</span><span class="n">reg_acceptor</span><span class="p">(</span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span> <span class="n">handle_json</span><span class="p">)</span>
<span class="n">chooser</span><span class="o">.</span><span class="n">reg_acceptor</span><span class="p">(</span><span class="s1">&#39;application/xml&#39;</span><span class="p">,</span> <span class="n">handle_xml</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="static-file-handling">
<span id="aiohttp-web-static-file-handling"></span><h2>Static file handling<a class="headerlink" href="#static-file-handling" title="Permalink to this headline">¶</a></h2>
<p>The best way to handle static files (images, JavaScripts, CSS files
etc.) is using <a class="reference external" href="https://en.wikipedia.org/wiki/Reverse_proxy">Reverse Proxy</a> like <a class="reference external" href="https://nginx.org/">nginx</a> or <a class="reference external" href="https://en.wikipedia.org/wiki/Content_delivery_network">CDN</a> services.</p>
<p>But for development it’s very convenient to handle static files by
aiohttp server itself.</p>
<p>To do it just register a new static route by
<a class="reference internal" href="web_reference.html#aiohttp.web.RouteTableDef.static" title="aiohttp.web.RouteTableDef.static"><code class="xref py py-meth docutils literal notranslate"><span class="pre">RouteTableDef.static()</span></code></a> or <a class="reference internal" href="web_reference.html#aiohttp.web.static" title="aiohttp.web.static"><code class="xref py py-func docutils literal notranslate"><span class="pre">static()</span></code></a> calls:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">app</span><span class="o">.</span><span class="n">add_routes</span><span class="p">([</span><span class="n">web</span><span class="o">.</span><span class="n">static</span><span class="p">(</span><span class="s1">&#39;/prefix&#39;</span><span class="p">,</span> <span class="n">path_to_static_folder</span><span class="p">)])</span>

<span class="n">routes</span><span class="o">.</span><span class="n">static</span><span class="p">(</span><span class="s1">&#39;/prefix&#39;</span><span class="p">,</span> <span class="n">path_to_static_folder</span><span class="p">)</span>
</pre></div>
</div>
<p>When a directory is accessed within a static route then the server responses
to client with <code class="docutils literal notranslate"><span class="pre">HTTP/403</span> <span class="pre">Forbidden</span></code> by default. Displaying folder index
instead could be enabled with <code class="docutils literal notranslate"><span class="pre">show_index</span></code> parameter set to <code class="docutils literal notranslate"><span class="pre">True</span></code>:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">web</span><span class="o">.</span><span class="n">static</span><span class="p">(</span><span class="s1">&#39;/prefix&#39;</span><span class="p">,</span> <span class="n">path_to_static_folder</span><span class="p">,</span> <span class="n">show_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>When a symlink from the static directory is accessed, the server responses to
client with <code class="docutils literal notranslate"><span class="pre">HTTP/404</span> <span class="pre">Not</span> <span class="pre">Found</span></code> by default. To allow the server to follow
symlinks, parameter <code class="docutils literal notranslate"><span class="pre">follow_symlinks</span></code> should be set to <code class="docutils literal notranslate"><span class="pre">True</span></code>:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">web</span><span class="o">.</span><span class="n">static</span><span class="p">(</span><span class="s1">&#39;/prefix&#39;</span><span class="p">,</span> <span class="n">path_to_static_folder</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>When you want to enable cache busting,
parameter <code class="docutils literal notranslate"><span class="pre">append_version</span></code> can be set to <code class="docutils literal notranslate"><span class="pre">True</span></code></p>
<p>Cache busting is the process of appending some form of file version hash
to the filename of resources like JavaScript and CSS files.
The performance advantage of doing this is that we can tell the browser
to cache these files indefinitely without worrying about the client not getting
the latest version when the file changes:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">web</span><span class="o">.</span><span class="n">static</span><span class="p">(</span><span class="s1">&#39;/prefix&#39;</span><span class="p">,</span> <span class="n">path_to_static_folder</span><span class="p">,</span> <span class="n">append_version</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="template-rendering">
<h2>Template Rendering<a class="headerlink" href="#template-rendering" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="web.html#module-aiohttp.web" title="aiohttp.web"><code class="xref py py-mod docutils literal notranslate"><span class="pre">aiohttp.web</span></code></a> does not support template rendering out-of-the-box.</p>
<p>However, there is a third-party library, <a class="reference external" href="https://aiohttp-jinja2.readthedocs.io/en/stable/index.html#module-aiohttp_jinja2" title="(in aiohttp_jinja2 v1.2)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">aiohttp_jinja2</span></code></a>, which is
supported by the <em>aiohttp</em> authors.</p>
<p>Using it is rather simple. First, setup a <em>jinja2 environment</em> with a call
to <a class="reference external" href="https://aiohttp-jinja2.readthedocs.io/en/stable/index.html#aiohttp_jinja2.setup" title="(in aiohttp_jinja2 v1.2)"><code class="xref py py-func docutils literal notranslate"><span class="pre">aiohttp_jinja2.setup()</span></code></a>:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">()</span>
<span class="n">aiohttp_jinja2</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">app</span><span class="p">,</span>
    <span class="n">loader</span><span class="o">=</span><span class="n">jinja2</span><span class="o">.</span><span class="n">FileSystemLoader</span><span class="p">(</span><span class="s1">&#39;/path/to/templates/folder&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>After that you may use the template engine in your
<a class="reference internal" href="web_quickstart.html#aiohttp-web-handler"><span class="std std-ref">handlers</span></a>. The most convenient way is to simply
wrap your handlers with the  <a class="reference external" href="https://aiohttp-jinja2.readthedocs.io/en/stable/index.html#aiohttp_jinja2.template" title="(in aiohttp_jinja2 v1.2)"><code class="xref py py-func docutils literal notranslate"><span class="pre">aiohttp_jinja2.template()</span></code></a> decorator:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@aiohttp_jinja2</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;tmpl.jinja2&#39;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Andrew&#39;</span><span class="p">,</span> <span class="s1">&#39;surname&#39;</span><span class="p">:</span> <span class="s1">&#39;Svetlov&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>If you prefer the <a class="reference external" href="http://www.makotemplates.org/">Mako</a> template engine, please take a look at the
<a class="reference external" href="https://github.com/aio-libs/aiohttp_mako">aiohttp_mako</a> library.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><a class="reference external" href="https://aiohttp-jinja2.readthedocs.io/en/stable/index.html#aiohttp_jinja2.template" title="(in aiohttp_jinja2 v1.2)"><code class="xref py py-func docutils literal notranslate"><span class="pre">aiohttp_jinja2.template()</span></code></a> should be applied <strong>before</strong>
<a class="reference internal" href="web_reference.html#aiohttp.web.RouteTableDef.get" title="aiohttp.web.RouteTableDef.get"><code class="xref py py-meth docutils literal notranslate"><span class="pre">RouteTableDef.get()</span></code></a> decorator and family, e.g. it must be
the <em>first</em> (most <em>down</em> decorator in the chain):</p>
<div class="last highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@routes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/path&#39;</span><span class="p">)</span>
<span class="nd">@aiohttp_jinja2</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;tmpl.jinja2&#39;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Andrew&#39;</span><span class="p">,</span> <span class="s1">&#39;surname&#39;</span><span class="p">:</span> <span class="s1">&#39;Svetlov&#39;</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="reading-from-the-same-task-in-websockets">
<span id="aiohttp-web-websocket-read-same-task"></span><h2>Reading from the same task in WebSockets<a class="headerlink" href="#reading-from-the-same-task-in-websockets" title="Permalink to this headline">¶</a></h2>
<p>Reading from the <em>WebSocket</em> (<code class="docutils literal notranslate"><span class="pre">await</span> <span class="pre">ws.receive()</span></code>) <strong>must only</strong> be
done inside the request handler <em>task</em>; however, writing
(<code class="docutils literal notranslate"><span class="pre">ws.send_str(...)</span></code>) to the <em>WebSocket</em>, closing (<code class="docutils literal notranslate"><span class="pre">await</span>
<span class="pre">ws.close()</span></code>) and canceling the handler task may be delegated to other
tasks. See also <a class="reference internal" href="faq.html#aiohttp-faq-terminating-websockets"><span class="std std-ref">FAQ section</span></a>.</p>
<p><a class="reference internal" href="web.html#module-aiohttp.web" title="aiohttp.web"><code class="xref py py-mod docutils literal notranslate"><span class="pre">aiohttp.web</span></code></a> creates an implicit <a class="reference external" href="https://docs.python.org/3/library/asyncio-task.html#asyncio.Task" title="(in Python v3.8)"><code class="xref py py-class docutils literal notranslate"><span class="pre">asyncio.Task</span></code></a> for
handling every incoming request.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">While <a class="reference internal" href="web.html#module-aiohttp.web" title="aiohttp.web"><code class="xref py py-mod docutils literal notranslate"><span class="pre">aiohttp.web</span></code></a> itself only supports <em>WebSockets</em> without
downgrading to <em>LONG-POLLING</em>, etc., our team supports <a class="reference external" href="https://github.com/aio-libs/sockjs">SockJS</a>, an
aiohttp-based library for implementing SockJS-compatible server
code.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Parallel reads from websocket are forbidden, there is no
possibility to call <code class="xref py py-meth docutils literal notranslate"><span class="pre">WebSocketResponse.receive()</span></code>
from two tasks.</p>
<p class="last">See <a class="reference internal" href="faq.html#aiohttp-faq-parallel-event-sources"><span class="std std-ref">FAQ section</span></a> for
instructions how to solve the problem.</p>
</div>
</div>
<div class="section" id="data-sharing-aka-no-singletons-please">
<span id="aiohttp-web-data-sharing"></span><h2>Data Sharing aka No Singletons Please<a class="headerlink" href="#data-sharing-aka-no-singletons-please" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="web.html#module-aiohttp.web" title="aiohttp.web"><code class="xref py py-mod docutils literal notranslate"><span class="pre">aiohttp.web</span></code></a> discourages the use of <em>global variables</em>, aka <em>singletons</em>.
Every variable should have its own context that is <em>not global</em>.</p>
<p>So, <a class="reference internal" href="web_reference.html#aiohttp.web.Application" title="aiohttp.web.Application"><code class="xref py py-class docutils literal notranslate"><span class="pre">Application</span></code></a> and <a class="reference internal" href="web_reference.html#aiohttp.web.Request" title="aiohttp.web.Request"><code class="xref py py-class docutils literal notranslate"><span class="pre">Request</span></code></a>
support a <a class="reference external" href="https://docs.python.org/3/library/collections.abc.html#collections.abc.MutableMapping" title="(in Python v3.8)"><code class="xref py py-class docutils literal notranslate"><span class="pre">collections.abc.MutableMapping</span></code></a> interface (i.e. they are
dict-like objects), allowing them to be used as data stores.</p>
<div class="section" id="application-s-config">
<span id="aiohttp-web-data-sharing-app-config"></span><h3>Application’s config<a class="headerlink" href="#application-s-config" title="Permalink to this headline">¶</a></h3>
<p>For storing <em>global-like</em> variables, feel free to save them in an
<a class="reference internal" href="web_reference.html#aiohttp.web.Application" title="aiohttp.web.Application"><code class="xref py py-class docutils literal notranslate"><span class="pre">Application</span></code></a> instance:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">app</span><span class="p">[</span><span class="s1">&#39;my_private_key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
</pre></div>
</div>
<p>and get it back in the <a class="reference internal" href="glossary.html#term-web-handler"><span class="xref std std-term">web-handler</span></a>:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="p">[</span><span class="s1">&#39;my_private_key&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>In case of <a class="reference internal" href="#aiohttp-web-nested-applications"><span class="std std-ref">nested applications</span></a> the desired lookup strategy could
be the following:</p>
<ol class="arabic simple">
<li>Search the key in the current nested application.</li>
<li>If the key is not found continue searching in the parent application(s).</li>
</ol>
<p>For this please use <a class="reference internal" href="web_reference.html#aiohttp.web.Request.config_dict" title="aiohttp.web.Request.config_dict"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Request.config_dict</span></code></a> read-only property:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;my_private_key&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="request-s-storage">
<h3>Request’s storage<a class="headerlink" href="#request-s-storage" title="Permalink to this headline">¶</a></h3>
<p>Variables that are only needed for the lifetime of a <a class="reference internal" href="web_reference.html#aiohttp.web.Request" title="aiohttp.web.Request"><code class="xref py py-class docutils literal notranslate"><span class="pre">Request</span></code></a>, can be
stored in a <a class="reference internal" href="web_reference.html#aiohttp.web.Request" title="aiohttp.web.Request"><code class="xref py py-class docutils literal notranslate"><span class="pre">Request</span></code></a>:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
  <span class="n">request</span><span class="p">[</span><span class="s1">&#39;my_private_key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;data&quot;</span>
  <span class="o">...</span>
</pre></div>
</div>
<p>This is mostly useful for <a class="reference internal" href="#aiohttp-web-middlewares"><span class="std std-ref">Middlewares</span></a> and
<a class="reference internal" href="#aiohttp-web-signals"><span class="std std-ref">Signals</span></a> handlers to store data for further processing by the
next handlers in the chain.</p>
</div>
<div class="section" id="response-s-storage">
<h3>Response’s storage<a class="headerlink" href="#response-s-storage" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="web_reference.html#aiohttp.web.StreamResponse" title="aiohttp.web.StreamResponse"><code class="xref py py-class docutils literal notranslate"><span class="pre">StreamResponse</span></code></a> and <a class="reference internal" href="web_reference.html#aiohttp.web.Response" title="aiohttp.web.Response"><code class="xref py py-class docutils literal notranslate"><span class="pre">Response</span></code></a> objects
also support <a class="reference external" href="https://docs.python.org/3/library/collections.abc.html#collections.abc.MutableMapping" title="(in Python v3.8)"><code class="xref py py-class docutils literal notranslate"><span class="pre">collections.abc.MutableMapping</span></code></a> interface. This is useful
when you want to share data with signals and middlewares once all the work in
the handler is done:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
  <span class="p">[</span> <span class="n">do</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">work</span> <span class="p">]</span>
  <span class="n">response</span><span class="p">[</span><span class="s1">&#39;my_metric&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">123</span>
  <span class="k">return</span> <span class="n">response</span>
</pre></div>
</div>
</div>
<div class="section" id="naming-hint">
<h3>Naming hint<a class="headerlink" href="#naming-hint" title="Permalink to this headline">¶</a></h3>
<p>To avoid clashing with other <em>aiohttp</em> users and third-party libraries, please
choose a unique key name for storing data.</p>
<p>If your code is published on PyPI, then the project name is most likely unique
and safe to use as the key.
Otherwise, something based on your company name/url would be satisfactory (i.e.
<code class="docutils literal notranslate"><span class="pre">org.company.app</span></code>).</p>
</div>
</div>
<div class="section" id="contextvars-support">
<span id="aiohttp-web-contextvars"></span><h2>ContextVars support<a class="headerlink" href="#contextvars-support" title="Permalink to this headline">¶</a></h2>
<p>Starting from Python 3.7 asyncio has <a class="reference external" href="https://docs.python.org/3/library/contextvars.html#module-contextvars" title="(in Python v3.8)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">Context</span> <span class="pre">Variables</span></code></a> as a
context-local storage (a generalization of thread-local concept that works with asyncio
tasks also).</p>
<p><em>aiohttp</em> server supports it in the following way:</p>
<ul>
<li><p class="first">A server inherits the current task’s context used when creating it.
<a class="reference internal" href="web_reference.html#aiohttp.web.run_app" title="aiohttp.web.run_app"><code class="xref py py-func docutils literal notranslate"><span class="pre">aiohttp.web.run_app()</span></code></a> runs a task for handling all underlying jobs running
the app, but alternatively <a class="reference internal" href="#aiohttp-web-app-runners"><span class="std std-ref">Application runners</span></a> can be used.</p>
</li>
<li><p class="first">Application initialization / finalization events (<a class="reference internal" href="web_reference.html#aiohttp.web.Application.cleanup_ctx" title="aiohttp.web.Application.cleanup_ctx"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Application.cleanup_ctx</span></code></a>,
<a class="reference internal" href="web_reference.html#aiohttp.web.Application.on_startup" title="aiohttp.web.Application.on_startup"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Application.on_startup</span></code></a> and <a class="reference internal" href="web_reference.html#aiohttp.web.Application.on_shutdown" title="aiohttp.web.Application.on_shutdown"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Application.on_shutdown</span></code></a>,
<a class="reference internal" href="web_reference.html#aiohttp.web.Application.on_cleanup" title="aiohttp.web.Application.on_cleanup"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Application.on_cleanup</span></code></a>) are executed inside the same context.</p>
<p>E.g. all context modifications made on application startup are visible on teardown.</p>
</li>
<li><p class="first">On every request handling <em>aiohttp</em> creates a context copy. <a class="reference internal" href="glossary.html#term-web-handler"><span class="xref std std-term">web-handler</span></a> has
all variables installed on initialization stage. But the context modification made by
a handler or middleware is invisible to another HTTP request handling call.</p>
</li>
</ul>
<p>An example of context vars usage:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">contextvars</span> <span class="k">import</span> <span class="n">ContextVar</span>

<span class="kn">from</span> <span class="nn">aiohttp</span> <span class="k">import</span> <span class="n">web</span>

<span class="n">VAR</span> <span class="o">=</span> <span class="n">ContextVar</span><span class="p">(</span><span class="s1">&#39;VAR&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">coro</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">VAR</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">VAR</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">VAR</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;handler&#39;</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="k">await</span> <span class="n">coro</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">var</span><span class="p">,</span>
                                        <span class="n">ret</span><span class="p">]))</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">on_startup</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;on_startup&#39;</span><span class="p">,</span> <span class="n">VAR</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
    <span class="n">VAR</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;on_startup&#39;</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">on_cleanup</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;on_cleanup&#39;</span><span class="p">,</span> <span class="n">VAR</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
    <span class="n">VAR</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;on_cleanup&#39;</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">init</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="n">VAR</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
    <span class="n">VAR</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">)</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">()</span>
    <span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>

    <span class="n">app</span><span class="o">.</span><span class="n">on_startup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">on_startup</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">on_cleanup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">on_cleanup</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">app</span>


<span class="n">web</span><span class="o">.</span><span class="n">run_app</span><span class="p">(</span><span class="n">init</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done&#39;</span><span class="p">,</span> <span class="n">VAR</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 3.5.</span></p>
</div>
</div>
<div class="section" id="middlewares">
<span id="aiohttp-web-middlewares"></span><h2>Middlewares<a class="headerlink" href="#middlewares" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="web.html#module-aiohttp.web" title="aiohttp.web"><code class="xref py py-mod docutils literal notranslate"><span class="pre">aiohttp.web</span></code></a> provides a powerful mechanism for customizing
<a class="reference internal" href="web_quickstart.html#aiohttp-web-handler"><span class="std std-ref">request handlers</span></a> via <em>middlewares</em>.</p>
<p>A <em>middleware</em> is a coroutine that can modify either the request or
response. For example, here’s a simple <em>middleware</em> which appends
<code class="docutils literal notranslate"><span class="pre">'</span> <span class="pre">wink'</span></code> to the response:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">aiohttp.web</span> <span class="k">import</span> <span class="n">middleware</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">middleware</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">+</span> <span class="s1">&#39; wink&#39;</span>
    <span class="k">return</span> <span class="n">resp</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">As of version <code class="docutils literal notranslate"><span class="pre">4.0.0</span></code> “new-style” middleware is default and the
<code class="docutils literal notranslate"><span class="pre">&#64;middleware</span></code> decorator is not required (and is deprecated), you can
simply remove the decorator. “Old-style” middleware (a coroutine which
returned a coroutine) is no longer supported.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The example won’t work with streamed responses or websockets</p>
</div>
<p>Every <em>middleware</em> should accept two parameters, a <a class="reference internal" href="web_reference.html#aiohttp.web.Request" title="aiohttp.web.Request"><code class="xref py py-class docutils literal notranslate"><span class="pre">request</span></code></a> instance and a <em>handler</em>, and return the response or raise
an exception. If the exception is not an instance of
<a class="reference internal" href="web_exceptions.html#aiohttp.web.HTTPException" title="aiohttp.web.HTTPException"><code class="xref py py-exc docutils literal notranslate"><span class="pre">HTTPException</span></code></a> it is converted to <code class="docutils literal notranslate"><span class="pre">500</span></code>
<a class="reference internal" href="web_exceptions.html#aiohttp.web.HTTPInternalServerError" title="aiohttp.web.HTTPInternalServerError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">HTTPInternalServerError</span></code></a> after processing the
middlewares chain.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Second argument should be named <em>handler</em> exactly.</p>
</div>
<p>When creating an <a class="reference internal" href="web_reference.html#aiohttp.web.Application" title="aiohttp.web.Application"><code class="xref py py-class docutils literal notranslate"><span class="pre">Application</span></code></a>, these <em>middlewares</em> are passed to
the keyword-only <code class="docutils literal notranslate"><span class="pre">middlewares</span></code> parameter:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">(</span><span class="n">middlewares</span><span class="o">=</span><span class="p">[</span><span class="n">middleware_1</span><span class="p">,</span>
                                   <span class="n">middleware_2</span><span class="p">])</span>
</pre></div>
</div>
<p>Internally, a single <a class="reference internal" href="web_quickstart.html#aiohttp-web-handler"><span class="std std-ref">request handler</span></a> is constructed
by applying the middleware chain to the original handler in reverse order,
and is called by the <code class="xref py py-class docutils literal notranslate"><span class="pre">RequestHandler</span></code> as a regular <em>handler</em>.</p>
<p>Since <em>middlewares</em> are themselves coroutines, they may perform extra
<code class="docutils literal notranslate"><span class="pre">await</span></code> calls when creating a new handler, e.g. call database etc.</p>
<p><em>Middlewares</em> usually call the handler, but they may choose to ignore it,
e.g. displaying <em>403 Forbidden page</em> or raising <a class="reference internal" href="web_exceptions.html#aiohttp.web.HTTPForbidden" title="aiohttp.web.HTTPForbidden"><code class="xref py py-exc docutils literal notranslate"><span class="pre">HTTPForbidden</span></code></a> exception
if the user does not have permissions to access the underlying resource.
They may also render errors raised by the handler, perform some pre- or
post-processing like handling <em>CORS</em> and so on.</p>
<p>The following code demonstrates middlewares execution order:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">aiohttp</span> <span class="k">import</span> <span class="n">web</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Handler function called&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Hello&quot;</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">middleware1</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Middleware 1 called&#39;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Middleware 1 finished&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">middleware2</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Middleware 2 called&#39;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Middleware 2 finished&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">(</span><span class="n">middlewares</span><span class="o">=</span><span class="p">[</span><span class="n">middleware1</span><span class="p">,</span> <span class="n">middleware2</span><span class="p">])</span>
<span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span>
<span class="n">web</span><span class="o">.</span><span class="n">run_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>
</div>
<p>Produced output:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">Middleware</span> <span class="mi">1</span> <span class="n">called</span>
<span class="n">Middleware</span> <span class="mi">2</span> <span class="n">called</span>
<span class="n">Handler</span> <span class="n">function</span> <span class="n">called</span>
<span class="n">Middleware</span> <span class="mi">2</span> <span class="n">finished</span>
<span class="n">Middleware</span> <span class="mi">1</span> <span class="n">finished</span>
</pre></div>
</div>
<div class="section" id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h3>
<p>A common use of middlewares is to implement custom error pages.  The following
example will render 404 errors using a JSON response, as might be appropriate
a JSON REST service:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">aiohttp</span> <span class="k">import</span> <span class="n">web</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">error_middleware</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">404</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">message</span>
    <span class="k">except</span> <span class="n">web</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ex</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">404</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="n">reason</span>
    <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">json_response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">})</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">(</span><span class="n">middlewares</span><span class="o">=</span><span class="p">[</span><span class="n">error_middleware</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="middleware-factory">
<h3>Middleware Factory<a class="headerlink" href="#middleware-factory" title="Permalink to this headline">¶</a></h3>
<p>A <em>middleware factory</em> is a function that creates a middleware with passed
arguments. For example, here’s a trivial <em>middleware factory</em>:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">middleware_factory</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">sample_middleware</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">+</span> <span class="n">text</span>
        <span class="k">return</span> <span class="n">resp</span>
    <span class="k">return</span> <span class="n">sample_middleware</span>
</pre></div>
</div>
<p>Note that in contrast to regular middlewares, a middleware factory should
return the function, not the value. So when passing a middleware factory
to the app you actually need to call it:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">(</span><span class="n">middlewares</span><span class="o">=</span><span class="p">[</span><span class="n">middleware_factory</span><span class="p">(</span><span class="s1">&#39; wink&#39;</span><span class="p">)])</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="signals">
<span id="aiohttp-web-signals"></span><h2>Signals<a class="headerlink" href="#signals" title="Permalink to this headline">¶</a></h2>
<p>Although <a class="reference internal" href="#aiohttp-web-middlewares"><span class="std std-ref">middlewares</span></a> can customize
<a class="reference internal" href="web_quickstart.html#aiohttp-web-handler"><span class="std std-ref">request handlers</span></a> before or after a <a class="reference internal" href="web_reference.html#aiohttp.web.Response" title="aiohttp.web.Response"><code class="xref py py-class docutils literal notranslate"><span class="pre">Response</span></code></a>
has been prepared, they can’t customize a <a class="reference internal" href="web_reference.html#aiohttp.web.Response" title="aiohttp.web.Response"><code class="xref py py-class docutils literal notranslate"><span class="pre">Response</span></code></a> <strong>while</strong> it’s
being prepared. For this <a class="reference internal" href="web.html#module-aiohttp.web" title="aiohttp.web"><code class="xref py py-mod docutils literal notranslate"><span class="pre">aiohttp.web</span></code></a> provides <em>signals</em>.</p>
<p>For example, a middleware can only change HTTP headers for <em>unprepared</em>
responses (see <code class="xref py py-meth docutils literal notranslate"><span class="pre">StreamResponse.prepare()</span></code>), but sometimes we
need a hook for changing HTTP headers for streamed responses and WebSockets.
This can be accomplished by subscribing to the
<a class="reference internal" href="web_reference.html#aiohttp.web.Application.on_response_prepare" title="aiohttp.web.Application.on_response_prepare"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Application.on_response_prepare</span></code></a> signal:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">on_prepare</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;My-Header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;value&#39;</span>

<span class="n">app</span><span class="o">.</span><span class="n">on_response_prepare</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">on_prepare</span><span class="p">)</span>
</pre></div>
</div>
<p>Additionally, the <a class="reference internal" href="web_reference.html#aiohttp.web.Application.on_startup" title="aiohttp.web.Application.on_startup"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Application.on_startup</span></code></a> and
<a class="reference internal" href="web_reference.html#aiohttp.web.Application.on_cleanup" title="aiohttp.web.Application.on_cleanup"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Application.on_cleanup</span></code></a> signals can be subscribed to for
application component setup and tear down accordingly.</p>
<p>The following example will properly initialize and dispose an aiopg connection
engine:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">aiopg.sa</span> <span class="k">import</span> <span class="n">create_engine</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">create_aiopg</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="n">app</span><span class="p">[</span><span class="s1">&#39;pg_engine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">create_engine</span><span class="p">(</span>
        <span class="n">user</span><span class="o">=</span><span class="s1">&#39;postgre&#39;</span><span class="p">,</span>
        <span class="n">database</span><span class="o">=</span><span class="s1">&#39;postgre&#39;</span><span class="p">,</span>
        <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="mi">5432</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">dispose_aiopg</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="n">app</span><span class="p">[</span><span class="s1">&#39;pg_engine&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">app</span><span class="p">[</span><span class="s1">&#39;pg_engine&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">wait_closed</span><span class="p">()</span>

<span class="n">app</span><span class="o">.</span><span class="n">on_startup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">create_aiopg</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">on_cleanup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dispose_aiopg</span><span class="p">)</span>
</pre></div>
</div>
<p>Signal handlers should not return a value but may modify incoming mutable
parameters.</p>
<p>Signal handlers will be run sequentially, in order they were
added. All handlers must be asynchronous since <em>aiohttp</em> 3.0.</p>
</div>
<div class="section" id="cleanup-context">
<span id="aiohttp-web-cleanup-ctx"></span><h2>Cleanup Context<a class="headerlink" href="#cleanup-context" title="Permalink to this headline">¶</a></h2>
<p>Bare <a class="reference internal" href="web_reference.html#aiohttp.web.Application.on_startup" title="aiohttp.web.Application.on_startup"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Application.on_startup</span></code></a> / <a class="reference internal" href="web_reference.html#aiohttp.web.Application.on_cleanup" title="aiohttp.web.Application.on_cleanup"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Application.on_cleanup</span></code></a>
pair still has a pitfall: signals handlers are independent on each other.</p>
<p>E.g. we have <code class="docutils literal notranslate"><span class="pre">[create_pg,</span> <span class="pre">create_redis]</span></code> in <em>startup</em> signal and
<code class="docutils literal notranslate"><span class="pre">[dispose_pg,</span> <span class="pre">dispose_redis]</span></code> in <em>cleanup</em>.</p>
<p>If, for example, <code class="docutils literal notranslate"><span class="pre">create_pg(app)</span></code> call fails <code class="docutils literal notranslate"><span class="pre">create_redis(app)</span></code>
is not called. But on application cleanup both <code class="docutils literal notranslate"><span class="pre">dispose_pg(app)</span></code> and
<code class="docutils literal notranslate"><span class="pre">dispose_redis(app)</span></code> are still called: <em>cleanup signal</em> has no
knowledge about startup/cleanup pairs and their execution state.</p>
<p>The solution is <a class="reference internal" href="web_reference.html#aiohttp.web.Application.cleanup_ctx" title="aiohttp.web.Application.cleanup_ctx"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Application.cleanup_ctx</span></code></a> usage:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">pg_engine</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="n">app</span><span class="p">[</span><span class="s1">&#39;pg_engine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">create_engine</span><span class="p">(</span>
        <span class="n">user</span><span class="o">=</span><span class="s1">&#39;postgre&#39;</span><span class="p">,</span>
        <span class="n">database</span><span class="o">=</span><span class="s1">&#39;postgre&#39;</span><span class="p">,</span>
        <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="mi">5432</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="p">)</span>
    <span class="k">yield</span>
    <span class="n">app</span><span class="p">[</span><span class="s1">&#39;pg_engine&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">app</span><span class="p">[</span><span class="s1">&#39;pg_engine&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">wait_closed</span><span class="p">()</span>

<span class="n">app</span><span class="o">.</span><span class="n">cleanup_ctx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pg_engine</span><span class="p">)</span>
</pre></div>
</div>
<p>The attribute is a list of <em>asynchronous generators</em>, a code <em>before</em>
<code class="docutils literal notranslate"><span class="pre">yield</span></code> is an initialization stage (called on <em>startup</em>), a code
<em>after</em> <code class="docutils literal notranslate"><span class="pre">yield</span></code> is executed on <em>cleanup</em>. The generator must have only
one <code class="docutils literal notranslate"><span class="pre">yield</span></code>.</p>
<p><em>aiohttp</em> guarantees that <em>cleanup code</em> is called if and only if
<em>startup code</em> was successfully finished.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 3.1.</span></p>
</div>
</div>
<div class="section" id="nested-applications">
<span id="aiohttp-web-nested-applications"></span><h2>Nested applications<a class="headerlink" href="#nested-applications" title="Permalink to this headline">¶</a></h2>
<p>Sub applications are designed for solving the problem of the big
monolithic code base.
Let’s assume we have a project with own business logic and tools like
administration panel and debug toolbar.</p>
<p>Administration panel is a separate application by its own nature but all
toolbar URLs are served by prefix like <code class="docutils literal notranslate"><span class="pre">/admin</span></code>.</p>
<p>Thus we’ll create a totally separate application named <code class="docutils literal notranslate"><span class="pre">admin</span></code> and
connect it to main app with prefix by
<a class="reference internal" href="web_reference.html#aiohttp.web.Application.add_subapp" title="aiohttp.web.Application.add_subapp"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Application.add_subapp()</span></code></a>:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">admin</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">()</span>
<span class="c1"># setup admin routes, signals and middlewares</span>

<span class="n">app</span><span class="o">.</span><span class="n">add_subapp</span><span class="p">(</span><span class="s1">&#39;/admin/&#39;</span><span class="p">,</span> <span class="n">admin</span><span class="p">)</span>
</pre></div>
</div>
<p>Middlewares and signals from <code class="docutils literal notranslate"><span class="pre">app</span></code> and <code class="docutils literal notranslate"><span class="pre">admin</span></code> are chained.</p>
<p>It means that if URL is <code class="docutils literal notranslate"><span class="pre">'/admin/something'</span></code> middlewares from
<code class="docutils literal notranslate"><span class="pre">app</span></code> are applied first and <code class="docutils literal notranslate"><span class="pre">admin.middlewares</span></code> are the next in
the call chain.</p>
<p>The same is going for
<a class="reference internal" href="web_reference.html#aiohttp.web.Application.on_response_prepare" title="aiohttp.web.Application.on_response_prepare"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Application.on_response_prepare</span></code></a> signal – the
signal is delivered to both top level <code class="docutils literal notranslate"><span class="pre">app</span></code> and <code class="docutils literal notranslate"><span class="pre">admin</span></code> if
processing URL is routed to <code class="docutils literal notranslate"><span class="pre">admin</span></code> sub-application.</p>
<p>Common signals like <a class="reference internal" href="web_reference.html#aiohttp.web.Application.on_startup" title="aiohttp.web.Application.on_startup"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Application.on_startup</span></code></a>,
<a class="reference internal" href="web_reference.html#aiohttp.web.Application.on_shutdown" title="aiohttp.web.Application.on_shutdown"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Application.on_shutdown</span></code></a> and
<a class="reference internal" href="web_reference.html#aiohttp.web.Application.on_cleanup" title="aiohttp.web.Application.on_cleanup"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Application.on_cleanup</span></code></a> are delivered to all
registered sub-applications. The passed parameter is sub-application
instance, not top-level application.</p>
<p>Third level sub-applications can be nested into second level ones –
there are no limitation for nesting level.</p>
<p>Url reversing for sub-applications should generate urls with proper prefix.</p>
<p>But for getting URL sub-application’s router should be used:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">admin</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">()</span>
<span class="n">admin</span><span class="o">.</span><span class="n">add_routes</span><span class="p">([</span><span class="n">web</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/resource&#39;</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">)])</span>

<span class="n">app</span><span class="o">.</span><span class="n">add_subapp</span><span class="p">(</span><span class="s1">&#39;/admin/&#39;</span><span class="p">,</span> <span class="n">admin</span><span class="p">)</span>

<span class="n">url</span> <span class="o">=</span> <span class="n">admin</span><span class="o">.</span><span class="n">router</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">url_for</span><span class="p">()</span>
</pre></div>
</div>
<p>The generated <code class="docutils literal notranslate"><span class="pre">url</span></code> from example will have a value
<code class="docutils literal notranslate"><span class="pre">URL('/admin/resource')</span></code>.</p>
<p>If main application should do URL reversing for sub-application it could
use the following explicit technique:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">admin</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">()</span>
<span class="n">admin</span><span class="o">.</span><span class="n">add_routes</span><span class="p">([</span><span class="n">web</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/resource&#39;</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">)])</span>

<span class="n">app</span><span class="o">.</span><span class="n">add_subapp</span><span class="p">(</span><span class="s1">&#39;/admin/&#39;</span><span class="p">,</span> <span class="n">admin</span><span class="p">)</span>
<span class="n">app</span><span class="p">[</span><span class="s1">&#39;admin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">admin</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>  <span class="c1"># main application&#39;s handler</span>
    <span class="n">admin</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="p">[</span><span class="s1">&#39;admin&#39;</span><span class="p">]</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">admin</span><span class="o">.</span><span class="n">router</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">url_for</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="expect-header">
<span id="aiohttp-web-expect-header"></span><h2><em>Expect</em> Header<a class="headerlink" href="#expect-header" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="web.html#module-aiohttp.web" title="aiohttp.web"><code class="xref py py-mod docutils literal notranslate"><span class="pre">aiohttp.web</span></code></a> supports <em>Expect</em> header. By default it sends
<code class="docutils literal notranslate"><span class="pre">HTTP/1.1</span> <span class="pre">100</span> <span class="pre">Continue</span></code> line to client, or raises
<a class="reference internal" href="web_exceptions.html#aiohttp.web.HTTPExpectationFailed" title="aiohttp.web.HTTPExpectationFailed"><code class="xref py py-exc docutils literal notranslate"><span class="pre">HTTPExpectationFailed</span></code></a> if header value is not equal to
“100-continue”. It is possible to specify custom <em>Expect</em> header
handler on per route basis. This handler gets called if <em>Expect</em>
header exist in request after receiving all headers and before
processing application’s <a class="reference internal" href="#aiohttp-web-middlewares"><span class="std std-ref">Middlewares</span></a> and
route handler. Handler can return <em>None</em>, in that case the request
processing continues as usual. If handler returns an instance of class
<a class="reference internal" href="web_reference.html#aiohttp.web.StreamResponse" title="aiohttp.web.StreamResponse"><code class="xref py py-class docutils literal notranslate"><span class="pre">StreamResponse</span></code></a>, <em>request handler</em> uses it as response. Also
handler can raise a subclass of <a class="reference internal" href="web_exceptions.html#aiohttp.web.HTTPException" title="aiohttp.web.HTTPException"><code class="xref py py-exc docutils literal notranslate"><span class="pre">HTTPException</span></code></a>. In this case all
further processing will not happen and client will receive appropriate
http response.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>A server that does not understand or is unable to comply with any of the
expectation values in the Expect field of a request MUST respond with
appropriate error status. The server MUST respond with a 417
(Expectation Failed) status if any of the expectations cannot be met or,
if there are other problems with the request, some other 4xx status.</p>
<p class="last"><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.20">http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.20</a></p>
</div>
<p>If all checks pass, the custom handler <em>must</em> write a <em>HTTP/1.1 100 Continue</em>
status code before returning.</p>
<p>The following example shows how to setup a custom handler for the <em>Expect</em>
header:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">check_auth</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">version</span> <span class="o">!=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">HttpVersion11</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;EXPECT&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;100-continue&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPExpectationFailed</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Unknown Expect: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">expect</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;AUTHORIZATION&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPForbidden</span><span class="p">()</span>

    <span class="n">request</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;HTTP/1.1 100 Continue</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;Hello, world&quot;</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">()</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_routes</span><span class="p">([</span><span class="n">web</span><span class="o">.</span><span class="n">add_get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">hello</span><span class="p">,</span> <span class="n">expect_handler</span><span class="o">=</span><span class="n">check_auth</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="section" id="custom-resource-implementation">
<span id="aiohttp-web-custom-resource"></span><h2>Custom resource implementation<a class="headerlink" href="#custom-resource-implementation" title="Permalink to this headline">¶</a></h2>
<p>To register custom resource use <code class="xref py py-meth docutils literal notranslate"><span class="pre">UrlDispatcher.register_resource()</span></code>.
Resource instance must implement <cite>AbstractResource</cite> interface.</p>
</div>
<div class="section" id="application-runners">
<span id="aiohttp-web-app-runners"></span><h2>Application runners<a class="headerlink" href="#application-runners" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="web_reference.html#aiohttp.web.run_app" title="aiohttp.web.run_app"><code class="xref py py-func docutils literal notranslate"><span class="pre">run_app()</span></code></a> provides a simple <em>blocking</em> API for running an
<a class="reference internal" href="web_reference.html#aiohttp.web.Application" title="aiohttp.web.Application"><code class="xref py py-class docutils literal notranslate"><span class="pre">Application</span></code></a>.</p>
<p>For starting the application <em>asynchronously</em> or serving on multiple
HOST/PORT <a class="reference internal" href="web_reference.html#aiohttp.web.AppRunner" title="aiohttp.web.AppRunner"><code class="xref py py-class docutils literal notranslate"><span class="pre">AppRunner</span></code></a> exists.</p>
<p>The simple startup code for serving HTTP site on <code class="docutils literal notranslate"><span class="pre">'localhost'</span></code>, port
<code class="docutils literal notranslate"><span class="pre">8080</span></code> looks like:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">runner</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">AppRunner</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="k">await</span> <span class="n">runner</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
<span class="n">site</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">TCPSite</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">)</span>
<span class="k">await</span> <span class="n">site</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3600</span><span class="p">)</span>  <span class="c1"># sleep forever</span>
</pre></div>
</div>
<p>To stop serving call <code class="xref py py-meth docutils literal notranslate"><span class="pre">AppRunner.cleanup()</span></code>:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">await</span> <span class="n">runner</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 3.0.</span></p>
</div>
</div>
<div class="section" id="graceful-shutdown">
<span id="aiohttp-web-graceful-shutdown"></span><h2>Graceful shutdown<a class="headerlink" href="#graceful-shutdown" title="Permalink to this headline">¶</a></h2>
<p>Stopping <em>aiohttp web server</em> by just closing all connections is not
always satisfactory.</p>
<p>The problem is: if application supports <a class="reference internal" href="glossary.html#term-websocket"><span class="xref std std-term">websocket</span></a>s or <em>data
streaming</em> it most likely has open connections at server
shutdown time.</p>
<p>The <em>library</em> has no knowledge how to close them gracefully but
developer can help by registering <a class="reference internal" href="web_reference.html#aiohttp.web.Application.on_shutdown" title="aiohttp.web.Application.on_shutdown"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Application.on_shutdown</span></code></a>
signal handler and call the signal on <em>web server</em> closing.</p>
<p>Developer should keep a list of opened connections
(<a class="reference internal" href="web_reference.html#aiohttp.web.Application" title="aiohttp.web.Application"><code class="xref py py-class docutils literal notranslate"><span class="pre">Application</span></code></a> is a good candidate).</p>
<p>The following <a class="reference internal" href="glossary.html#term-websocket"><span class="xref std std-term">websocket</span></a> snippet shows an example for websocket
handler:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">aiohttp</span> <span class="k">import</span> <span class="n">web</span>
<span class="kn">import</span> <span class="nn">weakref</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">()</span>
<span class="n">app</span><span class="p">[</span><span class="s1">&#39;websockets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakSet</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">websocket_handler</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">ws</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">WebSocketResponse</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">ws</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="p">[</span><span class="s1">&#39;websockets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">ws</span><span class="p">:</span>
            <span class="o">...</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="p">[</span><span class="s1">&#39;websockets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ws</span>
</pre></div>
</div>
<p>Signal handler may look like:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">aiohttp</span> <span class="k">import</span> <span class="n">WSCloseCode</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">on_shutdown</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ws</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">app</span><span class="p">[</span><span class="s1">&#39;websockets&#39;</span><span class="p">]):</span>
        <span class="k">await</span> <span class="n">ws</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">WSCloseCode</span><span class="o">.</span><span class="n">GOING_AWAY</span><span class="p">,</span>
                       <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Server shutdown&#39;</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">on_shutdown</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">on_shutdown</span><span class="p">)</span>
</pre></div>
</div>
<p>Both <a class="reference internal" href="web_reference.html#aiohttp.web.run_app" title="aiohttp.web.run_app"><code class="xref py py-func docutils literal notranslate"><span class="pre">run_app()</span></code></a> and <code class="xref py py-meth docutils literal notranslate"><span class="pre">AppRunner.cleanup()</span></code> call shutdown
signal handlers.</p>
</div>
<div class="section" id="background-tasks">
<span id="aiohttp-web-background-tasks"></span><h2>Background tasks<a class="headerlink" href="#background-tasks" title="Permalink to this headline">¶</a></h2>
<p>Sometimes there’s a need to perform some asynchronous operations just
after application start-up.</p>
<p>Even more, in some sophisticated systems there could be a need to run some
background tasks in the event loop along with the application’s request
handler. Such as listening to message queue or other network message/event
sources (e.g. ZeroMQ, Redis Pub/Sub, AMQP, etc.) to react to received messages
within the application.</p>
<p>For example the background task could listen to ZeroMQ on
<code class="xref py py-data docutils literal notranslate"><span class="pre">zmq.SUB</span></code> socket, process and forward retrieved messages to
clients connected via WebSocket that are stored somewhere in the
application (e.g. in the <code class="xref py py-obj docutils literal notranslate"><span class="pre">application['websockets']</span></code> list).</p>
<p>To run such short and long running background tasks aiohttp provides an
ability to register <a class="reference internal" href="web_reference.html#aiohttp.web.Application.on_startup" title="aiohttp.web.Application.on_startup"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Application.on_startup</span></code></a> signal handler(s) that
will run along with the application’s request handler.</p>
<p>For example there’s a need to run one quick task and two long running
tasks that will live till the application is alive. The appropriate
background tasks could be registered as an <a class="reference internal" href="web_reference.html#aiohttp.web.Application.on_startup" title="aiohttp.web.Application.on_startup"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Application.on_startup</span></code></a>
signal handlers as shown in the example below:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">listen_to_redis</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="k">await</span> <span class="n">aioredis</span><span class="o">.</span><span class="n">create_redis</span><span class="p">((</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">6379</span><span class="p">))</span>
        <span class="n">ch</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sub</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s1">&#39;news&#39;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">ch</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">):</span>
            <span class="c1"># Forward message to all connected websockets:</span>
            <span class="k">for</span> <span class="n">ws</span> <span class="ow">in</span> <span class="n">app</span><span class="p">[</span><span class="s1">&#39;websockets&#39;</span><span class="p">]:</span>
                <span class="n">ws</span><span class="o">.</span><span class="n">send_str</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">sub</span><span class="o">.</span><span class="n">unsubscribe</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">sub</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">start_background_tasks</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="n">app</span><span class="p">[</span><span class="s1">&#39;redis_listener&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">listen_to_redis</span><span class="p">(</span><span class="n">app</span><span class="p">))</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">cleanup_background_tasks</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="n">app</span><span class="p">[</span><span class="s1">&#39;redis_listener&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">app</span><span class="p">[</span><span class="s1">&#39;redis_listener&#39;</span><span class="p">]</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">()</span>
<span class="n">app</span><span class="o">.</span><span class="n">on_startup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start_background_tasks</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">on_cleanup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cleanup_background_tasks</span><span class="p">)</span>
<span class="n">web</span><span class="o">.</span><span class="n">run_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>
</div>
<p>The task <code class="xref py py-func docutils literal notranslate"><span class="pre">listen_to_redis()</span></code> will run forever.
To shut it down correctly <a class="reference internal" href="web_reference.html#aiohttp.web.Application.on_cleanup" title="aiohttp.web.Application.on_cleanup"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Application.on_cleanup</span></code></a> signal handler
may be used to send a cancellation to it.</p>
</div>
<div class="section" id="handling-error-pages">
<h2>Handling error pages<a class="headerlink" href="#handling-error-pages" title="Permalink to this headline">¶</a></h2>
<p>Pages like <em>404 Not Found</em> and <em>500 Internal Error</em> could be handled
by custom middleware, see <a class="reference external" href="https://aiohttp-demos.readthedocs.io/en/latest/tutorial.html#aiohttp-demos-polls-middlewares" title="(in aiohttp-demos v0.2)"><span class="xref std std-ref">polls demo</span></a>
for example.</p>
</div>
<div class="section" id="deploying-behind-a-proxy">
<span id="aiohttp-web-forwarded-support"></span><h2>Deploying behind a Proxy<a class="headerlink" href="#deploying-behind-a-proxy" title="Permalink to this headline">¶</a></h2>
<p>As discussed in <a class="reference internal" href="deployment.html#aiohttp-deployment"><span class="std std-ref">Server Deployment</span></a> the preferable way is
deploying <em>aiohttp</em> web server behind a <em>Reverse Proxy Server</em> like
<a class="reference internal" href="glossary.html#term-nginx"><span class="xref std std-term">nginx</span></a> for production usage.</p>
<p>In this way properties like <a class="reference internal" href="web_reference.html#aiohttp.web.BaseRequest.scheme" title="aiohttp.web.BaseRequest.scheme"><code class="xref py py-attr docutils literal notranslate"><span class="pre">BaseRequest.scheme</span></code></a>
<a class="reference internal" href="web_reference.html#aiohttp.web.BaseRequest.host" title="aiohttp.web.BaseRequest.host"><code class="xref py py-attr docutils literal notranslate"><span class="pre">BaseRequest.host</span></code></a> and <a class="reference internal" href="web_reference.html#aiohttp.web.BaseRequest.remote" title="aiohttp.web.BaseRequest.remote"><code class="xref py py-attr docutils literal notranslate"><span class="pre">BaseRequest.remote</span></code></a> are
incorrect.</p>
<p>Real values should be given from proxy server, usually either
<code class="docutils literal notranslate"><span class="pre">Forwarded</span></code> or old-fashion <code class="docutils literal notranslate"><span class="pre">X-Forwarded-For</span></code>,
<code class="docutils literal notranslate"><span class="pre">X-Forwarded-Host</span></code>, <code class="docutils literal notranslate"><span class="pre">X-Forwarded-Proto</span></code> HTTP headers are used.</p>
<p><em>aiohttp</em> does not take <em>forwarded</em> headers into account by default
because it produces <em>security issue</em>: HTTP client might add these
headers too, pushing non-trusted data values.</p>
<p>That’s why <em>aiohttp server</em> should setup <em>forwarded</em> headers in custom
middleware in tight conjunction with <em>reverse proxy configuration</em>.</p>
<p>For changing <a class="reference internal" href="web_reference.html#aiohttp.web.BaseRequest.scheme" title="aiohttp.web.BaseRequest.scheme"><code class="xref py py-attr docutils literal notranslate"><span class="pre">BaseRequest.scheme</span></code></a> <a class="reference internal" href="web_reference.html#aiohttp.web.BaseRequest.host" title="aiohttp.web.BaseRequest.host"><code class="xref py py-attr docutils literal notranslate"><span class="pre">BaseRequest.host</span></code></a> and
<a class="reference internal" href="web_reference.html#aiohttp.web.BaseRequest.remote" title="aiohttp.web.BaseRequest.remote"><code class="xref py py-attr docutils literal notranslate"><span class="pre">BaseRequest.remote</span></code></a> the middleware might use
<a class="reference internal" href="web_reference.html#aiohttp.web.BaseRequest.clone" title="aiohttp.web.BaseRequest.clone"><code class="xref py py-meth docutils literal notranslate"><span class="pre">BaseRequest.clone()</span></code></a>.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference external" href="https://github.com/aio-libs/aiohttp-remotes">https://github.com/aio-libs/aiohttp-remotes</a> provides secure helpers
for modifying <em>scheme</em>, <em>host</em> and <em>remote</em> attributes according
to <code class="docutils literal notranslate"><span class="pre">Forwarded</span></code> and <code class="docutils literal notranslate"><span class="pre">X-Forwarded-*</span></code> HTTP headers.</p>
</div>
</div>
<div class="section" id="swagger-support">
<h2>Swagger support<a class="headerlink" href="#swagger-support" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/cr0hn/aiohttp-swagger">aiohttp-swagger</a> is a
library that allow to add Swagger documentation and embed the
Swagger-UI into your <a class="reference internal" href="web.html#module-aiohttp.web" title="aiohttp.web"><code class="xref py py-mod docutils literal notranslate"><span class="pre">aiohttp.web</span></code></a> project.</p>
</div>
<div class="section" id="cors-support">
<h2>CORS support<a class="headerlink" href="#cors-support" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="web.html#module-aiohttp.web" title="aiohttp.web"><code class="xref py py-mod docutils literal notranslate"><span class="pre">aiohttp.web</span></code></a> itself does not support <a class="reference external" href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing">Cross-Origin Resource
Sharing</a>, but
there is an aiohttp plugin for it:
<a class="reference external" href="https://github.com/aio-libs/aiohttp_cors">aiohttp_cors</a>.</p>
</div>
<div class="section" id="debug-toolbar">
<h2>Debug Toolbar<a class="headerlink" href="#debug-toolbar" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/aio-libs/aiohttp_debugtoolbar">aiohttp-debugtoolbar</a> is a very useful library that provides a
debugging toolbar while you’re developing an <a class="reference internal" href="web.html#module-aiohttp.web" title="aiohttp.web"><code class="xref py py-mod docutils literal notranslate"><span class="pre">aiohttp.web</span></code></a>
application.</p>
<p>Install it with <code class="docutils literal notranslate"><span class="pre">pip</span></code>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ pip install aiohttp_debugtoolbar
</pre></div>
</div>
<p>Just call <code class="xref py py-func docutils literal notranslate"><span class="pre">aiohttp_debugtoolbar.setup()</span></code>:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">aiohttp_debugtoolbar</span>
<span class="kn">from</span> <span class="nn">aiohttp_debugtoolbar</span> <span class="k">import</span> <span class="n">toolbar_middleware_factory</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">()</span>
<span class="n">aiohttp_debugtoolbar</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>
</div>
<p>The toolbar is ready to use. Enjoy!!!</p>
</div>
<div class="section" id="dev-tools">
<h2>Dev Tools<a class="headerlink" href="#dev-tools" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/aio-libs/aiohttp-devtools">aiohttp-devtools</a> provides a couple of tools to simplify development of
<a class="reference internal" href="web.html#module-aiohttp.web" title="aiohttp.web"><code class="xref py py-mod docutils literal notranslate"><span class="pre">aiohttp.web</span></code></a> applications.</p>
<p>Install with <code class="docutils literal notranslate"><span class="pre">pip</span></code>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>  $ pip install aiohttp-devtools

 * <span class="sb">``</span>runserver<span class="sb">``</span> provides a development server with auto-reload,
live-reload, static file serving and aiohttp_debugtoolbar_
integration.
 * <span class="sb">``</span>start<span class="sb">``</span> is a <span class="sb">`</span>cookiecutter <span class="nb">command</span> which does the donkey work
of creating new :mod:<span class="sb">`</span>aiohttp.web<span class="sb">`</span> Applications.
</pre></div>
</div>
<p>Documentation and a complete tutorial of creating and running an app
locally are available at <a class="reference external" href="https://github.com/aio-libs/aiohttp-devtools">aiohttp-devtools</a>.</p>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="index.html">
    <img class="logo" src="_static/teanga-logo.svg" alt="Logo"/>
    
  </a>
</p>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=pret-a-llod&repo=teanga&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="create_workflow.html">How to create a workflow in Teanga</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, teanga maintainers.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/web_advanced.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    
    <a href="https://github.com/pret-a-llod/teanga" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>