
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Testing &#8212; Teanga</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/teanga-logo.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
    <link rel="canonical" href="http://pret-a-llod.github.io/teanga/examples/testing.html"/>
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <span class="target" id="module-aiohttp.test_utils"></span><div class="section" id="testing">
<span id="aiohttp-testing"></span><h1>Testing<a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h1>
<div class="section" id="testing-aiohttp-web-servers">
<h2>Testing aiohttp web servers<a class="headerlink" href="#testing-aiohttp-web-servers" title="Permalink to this headline">¶</a></h2>
<p>aiohttp provides plugin for <em>pytest</em> making writing web server tests
extremely easy, it also provides <a class="reference internal" href="#aiohttp-testing-framework-agnostic-utilities"><span class="std std-ref">test framework agnostic
utilities</span></a> for testing
with other frameworks such as <a class="reference internal" href="#aiohttp-testing-unittest-example"><span class="std std-ref">unittest</span></a>.</p>
<p>Before starting to write your tests, you may also be interested on
reading <a class="reference internal" href="#aiohttp-testing-writing-testable-services"><span class="std std-ref">how to write testable
services</span></a> that interact
with the loop.</p>
<p>For using pytest plugin please install <a class="reference external" href="https://pypi.python.org/pypi/pytest-aiohttp">pytest-aiohttp</a> library:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ pip install pytest-aiohttp
</pre></div>
</div>
<p>If you don’t want to install <em>pytest-aiohttp</em> for some reason you may
insert <code class="docutils literal notranslate"><span class="pre">pytest_plugins</span> <span class="pre">=</span> <span class="pre">'aiohttp.pytest_plugin'</span></code> line into
<code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> instead for the same functionality.</p>
<div class="section" id="provisional-status">
<h3>Provisional Status<a class="headerlink" href="#provisional-status" title="Permalink to this headline">¶</a></h3>
<p>The module is a <strong>provisional</strong>.</p>
<p><em>aiohttp</em> has a year and half period for removing deprecated API
(<span class="xref std std-ref">aiohttp-backward-compatibility-policy</span>).</p>
<p>But for <code class="xref py py-mod docutils literal notranslate"><span class="pre">aiohttp.test_tools</span></code> the deprecation period could be reduced.</p>
<p>Moreover we may break <em>backward compatibility</em> without <em>deprecation
period</em> for some very strong reason.</p>
</div>
<div class="section" id="the-test-client-and-servers">
<h3>The Test Client and Servers<a class="headerlink" href="#the-test-client-and-servers" title="Permalink to this headline">¶</a></h3>
<p><em>aiohttp</em> test utils provides a scaffolding for testing aiohttp-based
web servers.</p>
<p>They consist of two parts: running test server and making HTTP
requests to this server.</p>
<p><a class="reference internal" href="#aiohttp.test_utils.TestServer" title="aiohttp.test_utils.TestServer"><code class="xref py py-class docutils literal notranslate"><span class="pre">TestServer</span></code></a> runs <a class="reference internal" href="web_reference.html#aiohttp.web.Application" title="aiohttp.web.Application"><code class="xref py py-class docutils literal notranslate"><span class="pre">aiohttp.web.Application</span></code></a>
based server, <a class="reference internal" href="#aiohttp.test_utils.RawTestServer" title="aiohttp.test_utils.RawTestServer"><code class="xref py py-class docutils literal notranslate"><span class="pre">RawTestServer</span></code></a> starts
<code class="xref py py-class docutils literal notranslate"><span class="pre">aiohttp.web.WebServer</span></code> low level server.</p>
<p>For performing HTTP requests to these servers you have to create a
test client: <a class="reference internal" href="#aiohttp.test_utils.TestClient" title="aiohttp.test_utils.TestClient"><code class="xref py py-class docutils literal notranslate"><span class="pre">TestClient</span></code></a> instance.</p>
<p>The client incapsulates <code class="xref py py-class docutils literal notranslate"><span class="pre">aiohttp.ClientSession</span></code> by providing
proxy methods to the client for common operations such as
<em>ws_connect</em>, <em>get</em>, <em>post</em>, etc.</p>
</div>
<div class="section" id="pytest">
<h3>Pytest<a class="headerlink" href="#pytest" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="#pytest_aiohttp.aiohttp_client" title="pytest_aiohttp.aiohttp_client"><code class="xref py py-data docutils literal notranslate"><span class="pre">aiohttp_client</span></code></a> fixture available from <a class="reference external" href="https://pypi.python.org/pypi/pytest-aiohttp">pytest-aiohttp</a> plugin
allows you to create a client to make requests to test your app.</p>
<p>A simple would be:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">aiohttp</span> <span class="k">import</span> <span class="n">web</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Hello, world&#39;</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">test_hello</span><span class="p">(</span><span class="n">aiohttp_client</span><span class="p">):</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">()</span>
    <span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">hello</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="k">await</span> <span class="n">aiohttp_client</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s1">&#39;Hello, world&#39;</span> <span class="ow">in</span> <span class="n">text</span>
</pre></div>
</div>
<p>It also provides access to the app instance allowing tests to check the state
of the app. Tests can be made even more succinct with a fixture to create an
app test client:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">aiohttp</span> <span class="k">import</span> <span class="n">web</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">previous</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">post</span><span class="p">())[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;thanks for the data&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span>
        <span class="n">body</span><span class="o">=</span><span class="s1">&#39;value: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">cli</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">aiohttp_client</span><span class="p">):</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">()</span>
    <span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_post</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">aiohttp_client</span><span class="p">(</span><span class="n">app</span><span class="p">))</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">test_set_value</span><span class="p">(</span><span class="n">cli</span><span class="p">):</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cli</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">})</span>
    <span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;thanks for the data&#39;</span>
    <span class="k">assert</span> <span class="n">cli</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">app</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;foo&#39;</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">test_get_value</span><span class="p">(</span><span class="n">cli</span><span class="p">):</span>
    <span class="n">cli</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">app</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cli</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;value: bar&#39;</span>
</pre></div>
</div>
<p>Pytest tooling has the following fixtures:</p>
<dl class="data">
<dt id="pytest_aiohttp.aiohttp_server">
<code class="descclassname">pytest_aiohttp.</code><code class="descname">aiohttp_server</code><span class="sig-paren">(</span><em>app</em>, <em>*</em>, <em>port=None</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#pytest_aiohttp.aiohttp_server" title="Permalink to this definition">¶</a></dt>
<dd><p>A fixture factory that creates
<a class="reference internal" href="#aiohttp.test_utils.TestServer" title="aiohttp.test_utils.TestServer"><code class="xref py py-class docutils literal notranslate"><span class="pre">TestServer</span></code></a>:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">test_f</span><span class="p">(</span><span class="n">aiohttp_server</span><span class="p">):</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">()</span>
    <span class="c1"># fill route table</span>

    <span class="n">server</span> <span class="o">=</span> <span class="k">await</span> <span class="n">aiohttp_server</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>
</div>
<p>The server will be destroyed on exit from test function.</p>
<dl class="docutils">
<dt><em>app</em> is the <a class="reference internal" href="web_reference.html#aiohttp.web.Application" title="aiohttp.web.Application"><code class="xref py py-class docutils literal notranslate"><span class="pre">aiohttp.web.Application</span></code></a> used</dt>
<dd>to start server.</dd>
</dl>
<p><em>port</em> optional, port the server is run at, if
not provided a random unused port is used.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 3.0.</span></p>
</div>
<dl class="docutils">
<dt><em>kwargs</em> are parameters passed to</dt>
<dd><a class="reference internal" href="web_reference.html#aiohttp.web.AppRunner" title="aiohttp.web.AppRunner"><code class="xref py py-meth docutils literal notranslate"><span class="pre">aiohttp.web.AppRunner()</span></code></a></dd>
</dl>
<div class="versionchanged">
<p><span class="versionmodified">Changed in version 3.0.</span></p>
</div>
<div class="deprecated">
<p><span class="versionmodified">Deprecated since version 3.2: </span>The fixture was renamed from <code class="docutils literal notranslate"><span class="pre">test_server</span></code> to <code class="docutils literal notranslate"><span class="pre">aiohttp_server</span></code>.</p>
</div>
</dd></dl>

<dl class="data">
<dt id="pytest_aiohttp.aiohttp_client">
<code class="descclassname">pytest_aiohttp.</code><code class="descname">aiohttp_client</code><span class="sig-paren">(</span><em>app</em>, <em>server_kwargs=None</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#pytest_aiohttp.aiohttp_client" title="Permalink to this definition">¶</a></dt>
<dt>
<code class="descclassname">pytest_aiohttp.</code><code class="descname">aiohttp_client</code><span class="sig-paren">(</span><em>server</em>, <em>**kwargs</em><span class="sig-paren">)</span></dt>
<dt>
<code class="descclassname">pytest_aiohttp.</code><code class="descname">aiohttp_client</code><span class="sig-paren">(</span><em>raw_server</em>, <em>**kwargs</em><span class="sig-paren">)</span></dt>
<dd><p>A fixture factory that creates
<a class="reference internal" href="#aiohttp.test_utils.TestClient" title="aiohttp.test_utils.TestClient"><code class="xref py py-class docutils literal notranslate"><span class="pre">TestClient</span></code></a> for access to tested server:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">test_f</span><span class="p">(</span><span class="n">aiohttp_client</span><span class="p">):</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">()</span>
    <span class="c1"># fill route table</span>

    <span class="n">client</span> <span class="o">=</span> <span class="k">await</span> <span class="n">aiohttp_client</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><em>client</em> and responses are cleaned up after test function finishing.</p>
<p>The fixture accepts <a class="reference internal" href="web_reference.html#aiohttp.web.Application" title="aiohttp.web.Application"><code class="xref py py-class docutils literal notranslate"><span class="pre">aiohttp.web.Application</span></code></a>,
<a class="reference internal" href="#aiohttp.test_utils.TestServer" title="aiohttp.test_utils.TestServer"><code class="xref py py-class docutils literal notranslate"><span class="pre">aiohttp.test_utils.TestServer</span></code></a> or
<a class="reference internal" href="#aiohttp.test_utils.RawTestServer" title="aiohttp.test_utils.RawTestServer"><code class="xref py py-class docutils literal notranslate"><span class="pre">aiohttp.test_utils.RawTestServer</span></code></a> instance.</p>
<p><em>server_kwargs</em> are parameters passed to the test server if an app
is passed, else ignored.</p>
<p><em>kwargs</em> are parameters passed to
<a class="reference internal" href="#aiohttp.test_utils.TestClient" title="aiohttp.test_utils.TestClient"><code class="xref py py-class docutils literal notranslate"><span class="pre">aiohttp.test_utils.TestClient</span></code></a> constructor.</p>
<div class="versionchanged">
<p><span class="versionmodified">Changed in version 3.0: </span>The fixture was renamed from <code class="docutils literal notranslate"><span class="pre">test_client</span></code> to <code class="docutils literal notranslate"><span class="pre">aiohttp_client</span></code>.</p>
</div>
</dd></dl>

<dl class="data">
<dt id="pytest_aiohttp.aiohttp_raw_server">
<code class="descclassname">pytest_aiohttp.</code><code class="descname">aiohttp_raw_server</code><span class="sig-paren">(</span><em>handler</em>, <em>*</em>, <em>port=None</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#pytest_aiohttp.aiohttp_raw_server" title="Permalink to this definition">¶</a></dt>
<dd><p>A fixture factory that creates
<a class="reference internal" href="#aiohttp.test_utils.RawTestServer" title="aiohttp.test_utils.RawTestServer"><code class="xref py py-class docutils literal notranslate"><span class="pre">RawTestServer</span></code></a> instance from given web
handler.:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">test_f</span><span class="p">(</span><span class="n">aiohttp_raw_server</span><span class="p">,</span> <span class="n">aiohttp_client</span><span class="p">):</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;OK&quot;</span><span class="p">)</span>

    <span class="n">raw_server</span> <span class="o">=</span> <span class="k">await</span> <span class="n">aiohttp_raw_server</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="k">await</span> <span class="n">aiohttp_client</span><span class="p">(</span><span class="n">raw_server</span><span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><em>handler</em> should be a coroutine which accepts a request and returns
response, e.g.</p>
<p><em>port</em> optional, port the server is run at, if
not provided a random unused port is used.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 3.0.</span></p>
</div>
</dd></dl>

<dl class="data">
<dt id="pytest_aiohttp.aiohttp_unused_port">
<code class="descclassname">pytest_aiohttp.</code><code class="descname">aiohttp_unused_port</code><a class="headerlink" href="#pytest_aiohttp.aiohttp_unused_port" title="Permalink to this definition">¶</a></dt>
<dd><p>Function to return an unused port number for IPv4 TCP protocol:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">test_f</span><span class="p">(</span><span class="n">aiohttp_client</span><span class="p">,</span> <span class="n">aiohttp_unused_port</span><span class="p">):</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">aiohttp_unused_port</span><span class="p">()</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">()</span>
    <span class="c1"># fill route table</span>

    <span class="n">client</span> <span class="o">=</span> <span class="k">await</span> <span class="n">aiohttp_client</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">server_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">})</span>
    <span class="o">...</span>
</pre></div>
</div>
<div class="versionchanged">
<p><span class="versionmodified">Changed in version 3.0: </span>The fixture was renamed from <code class="docutils literal notranslate"><span class="pre">unused_port</span></code> to <code class="docutils literal notranslate"><span class="pre">aiohttp_unused_port</span></code>.</p>
</div>
</dd></dl>

<dl class="data">
<dt id="pytest_aiohttp.aiohttp_client_cls">
<code class="descclassname">pytest_aiohttp.</code><code class="descname">aiohttp_client_cls</code><a class="headerlink" href="#pytest_aiohttp.aiohttp_client_cls" title="Permalink to this definition">¶</a></dt>
<dd><p>A fixture for passing custom <a class="reference internal" href="#aiohttp.test_utils.TestClient" title="aiohttp.test_utils.TestClient"><code class="xref py py-class docutils literal notranslate"><span class="pre">TestClient</span></code></a> implementations:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyClient</span><span class="p">(</span><span class="n">TestClient</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">pw</span><span class="p">):</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">pw</span><span class="p">}</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">aiohttp_client_cls</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">MyClient</span>

<span class="k">def</span> <span class="nf">test_login</span><span class="p">(</span><span class="n">aiohttp_client</span><span class="p">):</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">()</span>
    <span class="n">client</span> <span class="o">=</span> <span class="k">await</span> <span class="n">aiohttp_client</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s2">&quot;s3cr3t&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>If you want to switch between different clients in tests, you can use
the usual <code class="docutils literal notranslate"><span class="pre">pytest</span></code> machinery. Example with using test markers:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RESTfulClient</span><span class="p">(</span><span class="n">TestClient</span><span class="p">):</span>
    <span class="o">...</span>

<span class="k">class</span> <span class="nc">GraphQLClient</span><span class="p">(</span><span class="n">TestClient</span><span class="p">):</span>
    <span class="o">...</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">aiohttp_client_cls</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_closest_marker</span><span class="p">(</span><span class="s1">&#39;rest&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RESTfulClient</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_closest_marker</span><span class="p">(</span><span class="s1">&#39;graphql&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">GraphQLClient</span>
    <span class="k">return</span> <span class="n">TestClient</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">rest</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">test_rest</span><span class="p">(</span><span class="n">aiohttp_client</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">client</span><span class="p">:</span> <span class="n">RESTfulClient</span> <span class="o">=</span> <span class="k">await</span> <span class="n">aiohttp_client</span><span class="p">(</span><span class="n">Application</span><span class="p">())</span>
    <span class="o">...</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">graphql</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">test_graphql</span><span class="p">(</span><span class="n">aiohttp_client</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">client</span><span class="p">:</span> <span class="n">GraphQLClient</span> <span class="o">=</span> <span class="k">await</span> <span class="n">aiohttp_client</span><span class="p">(</span><span class="n">Application</span><span class="p">())</span>
    <span class="o">...</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="unittest">
<span id="aiohttp-testing-unittest-style"></span><span id="aiohttp-testing-unittest-example"></span><h3>Unittest<a class="headerlink" href="#unittest" title="Permalink to this headline">¶</a></h3>
<p>To test applications with the standard library’s unittest or unittest-based
functionality, the AioHTTPTestCase is provided:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">aiohttp.test_utils</span> <span class="k">import</span> <span class="n">AioHTTPTestCase</span><span class="p">,</span> <span class="n">unittest_run_loop</span>
<span class="kn">from</span> <span class="nn">aiohttp</span> <span class="k">import</span> <span class="n">web</span>

<span class="k">class</span> <span class="nc">MyAppTestCase</span><span class="p">(</span><span class="n">AioHTTPTestCase</span><span class="p">):</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_application</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Override the get_app method to return your application.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Hello, world&#39;</span><span class="p">)</span>

        <span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">()</span>
        <span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">hello</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">app</span>

    <span class="c1"># the unittest_run_loop decorator can be used in tandem with</span>
    <span class="c1"># the AioHTTPTestCase to simplify running</span>
    <span class="c1"># tests that are asynchronous</span>
    <span class="nd">@unittest_run_loop</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">test_example</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span>
        <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
        <span class="k">assert</span> <span class="s2">&quot;Hello, world&quot;</span> <span class="ow">in</span> <span class="n">text</span>

    <span class="c1"># a vanilla example</span>
    <span class="k">def</span> <span class="nf">test_example_vanilla</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">test_get_route</span><span class="p">():</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span>
            <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
            <span class="k">assert</span> <span class="s2">&quot;Hello, world&quot;</span> <span class="ow">in</span> <span class="n">text</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">test_get_route</span><span class="p">())</span>
</pre></div>
</div>
<dl class="class">
<dt id="aiohttp.test_utils.AioHTTPTestCase">
<em class="property">class </em><code class="descclassname">aiohttp.test_utils.</code><code class="descname">AioHTTPTestCase</code><a class="reference internal" href="../_modules/aiohttp/test_utils.html#AioHTTPTestCase"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#aiohttp.test_utils.AioHTTPTestCase" title="Permalink to this definition">¶</a></dt>
<dd><blockquote>
<div><p>A base class to allow for unittest web applications using aiohttp.</p>
<p>Derived from <code class="xref py py-class docutils literal notranslate"><span class="pre">unittest.TestCase</span></code></p>
<p>Provides the following:</p>
<dl class="attribute">
<dt id="aiohttp.test_utils.AioHTTPTestCase.client">
<code class="descname">client</code><a class="headerlink" href="#aiohttp.test_utils.AioHTTPTestCase.client" title="Permalink to this definition">¶</a></dt>
<dd><p>an aiohttp test client, <a class="reference internal" href="#aiohttp.test_utils.TestClient" title="aiohttp.test_utils.TestClient"><code class="xref py py-class docutils literal notranslate"><span class="pre">TestClient</span></code></a> instance.</p>
</dd></dl>

<dl class="attribute">
<dt id="aiohttp.test_utils.AioHTTPTestCase.server">
<code class="descname">server</code><a class="headerlink" href="#aiohttp.test_utils.AioHTTPTestCase.server" title="Permalink to this definition">¶</a></dt>
<dd><p>an aiohttp test server, <a class="reference internal" href="#aiohttp.test_utils.TestServer" title="aiohttp.test_utils.TestServer"><code class="xref py py-class docutils literal notranslate"><span class="pre">TestServer</span></code></a> instance.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.3.</span></p>
</div>
</dd></dl>

<dl class="attribute">
<dt id="aiohttp.test_utils.AioHTTPTestCase.loop">
<code class="descname">loop</code><a class="headerlink" href="#aiohttp.test_utils.AioHTTPTestCase.loop" title="Permalink to this definition">¶</a></dt>
<dd><p>The event loop in which the application and server are running.</p>
<div class="deprecated">
<p><span class="versionmodified">Deprecated since version 3.5.</span></p>
</div>
</dd></dl>

<dl class="attribute">
<dt id="aiohttp.test_utils.AioHTTPTestCase.app">
<code class="descname">app</code><a class="headerlink" href="#aiohttp.test_utils.AioHTTPTestCase.app" title="Permalink to this definition">¶</a></dt>
<dd><p>The application returned by <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_app()</span></code>
(<a class="reference internal" href="web_reference.html#aiohttp.web.Application" title="aiohttp.web.Application"><code class="xref py py-class docutils literal notranslate"><span class="pre">aiohttp.web.Application</span></code></a> instance).</p>
</dd></dl>

<dl class="method">
<dt id="aiohttp.test_utils.AioHTTPTestCase.setUp">
<code class="descname">setUp</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/aiohttp/test_utils.html#AioHTTPTestCase.setUp"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#aiohttp.test_utils.AioHTTPTestCase.setUp" title="Permalink to this definition">¶</a></dt>
<dd><p>Standard test initialization method.</p>
</dd></dl>

<dl class="method">
<dt id="aiohttp.test_utils.AioHTTPTestCase.tearDown">
<code class="descname">tearDown</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/aiohttp/test_utils.html#AioHTTPTestCase.tearDown"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#aiohttp.test_utils.AioHTTPTestCase.tearDown" title="Permalink to this definition">¶</a></dt>
<dd><p>Standard test finalization method.</p>
</dd></dl>

</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">TestClient</span></code>’s methods are asynchronous: you have to
execute function on the test client using asynchronous methods.</p>
<p>A basic test class wraps every test method by
<code class="xref py py-func docutils literal notranslate"><span class="pre">unittest_run_loop()</span></code> decorator:</p>
<div class="last highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestA</span><span class="p">(</span><span class="n">AioHTTPTestCase</span><span class="p">):</span>

    <span class="nd">@unittest_run_loop</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">test_f</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</dd></dl>

<dl class="function">
<dt>
<code class="descname">unittest_run_loop:</code></dt>
<dd><p>A decorator dedicated to use with asynchronous methods of an
<a class="reference internal" href="#aiohttp.test_utils.AioHTTPTestCase" title="aiohttp.test_utils.AioHTTPTestCase"><code class="xref py py-class docutils literal notranslate"><span class="pre">AioHTTPTestCase</span></code></a>.</p>
<p>Handles executing an asynchronous function, using
the <a class="reference internal" href="#aiohttp.test_utils.AioHTTPTestCase.loop" title="aiohttp.test_utils.AioHTTPTestCase.loop"><code class="xref py py-attr docutils literal notranslate"><span class="pre">AioHTTPTestCase.loop</span></code></a> of the <a class="reference internal" href="#aiohttp.test_utils.AioHTTPTestCase" title="aiohttp.test_utils.AioHTTPTestCase"><code class="xref py py-class docutils literal notranslate"><span class="pre">AioHTTPTestCase</span></code></a>.</p>
</dd></dl>

<div class="section" id="patching-unittest-test-cases">
<h4>Patching unittest test cases<a class="headerlink" href="#patching-unittest-test-cases" title="Permalink to this headline">¶</a></h4>
<p>Patching test cases is tricky, when using python older than 3.8  <code class="xref py py-func docutils literal notranslate"><span class="pre">patch()</span></code> does not behave as it has to.
We recommend using <code class="xref py py-mod docutils literal notranslate"><span class="pre">asynctest</span></code> that provides <code class="xref py py-func docutils literal notranslate"><span class="pre">patch()</span></code> that is capable of creating
a magic mock that supports async. It can be used with a decorator as well as with a context manager:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="hll"> <span class="kn">from</span> <span class="nn">asynctest.mock</span> <span class="kn">import</span> <span class="n">patch</span> <span class="k">as</span> <span class="n">async_patch</span>
</span>
 <span class="kn">from</span> <span class="nn">aiohttp.test_utils</span> <span class="kn">import</span> <span class="n">AioHTTPTestCase</span><span class="p">,</span> <span class="n">unittest_run_loop</span>
 <span class="kn">from</span> <span class="nn">aiohttp.web_app</span> <span class="kn">import</span> <span class="n">Application</span>
 <span class="kn">from</span> <span class="nn">aiohttp.web_request</span> <span class="kn">import</span> <span class="n">Request</span>
 <span class="kn">from</span> <span class="nn">aiohttp.web_response</span> <span class="kn">import</span> <span class="n">Response</span>
 <span class="kn">from</span> <span class="nn">aiohttp.web_routedef</span> <span class="kn">import</span> <span class="n">get</span>


 <span class="n">async</span> <span class="k">def</span> <span class="nf">do_something</span><span class="p">():</span>
     <span class="k">print</span><span class="p">(</span><span class="s1">&#39;something&#39;</span><span class="p">)</span>


 <span class="n">async</span> <span class="k">def</span> <span class="nf">ping</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
     <span class="n">await</span> <span class="n">do_something</span><span class="p">()</span>
     <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;pong&#39;</span><span class="p">)</span>


 <span class="k">class</span> <span class="nc">TestApplication</span><span class="p">(</span><span class="n">AioHTTPTestCase</span><span class="p">):</span>
     <span class="k">def</span> <span class="nf">get_app</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Application</span><span class="p">:</span>
         <span class="n">app</span> <span class="o">=</span> <span class="n">Application</span><span class="p">()</span>
         <span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_routes</span><span class="p">([</span>
             <span class="n">get</span><span class="p">(</span><span class="s1">&#39;/ping/&#39;</span><span class="p">,</span> <span class="n">ping</span><span class="p">)</span>
         <span class="p">])</span>

         <span class="k">return</span> <span class="n">app</span>

     <span class="nd">@unittest_run_loop</span>
     <span class="n">async</span> <span class="k">def</span> <span class="nf">test_ping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="n">resp</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/ping/&#39;</span><span class="p">)</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span> <span class="s1">&#39;pong&#39;</span><span class="p">)</span>

     <span class="nd">@unittest_run_loop</span>
     <span class="n">async</span> <span class="k">def</span> <span class="nf">test_ping_mocked_do_something</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="hll">         <span class="k">with</span> <span class="n">async_patch</span><span class="p">(</span><span class="s1">&#39;tests.do_something&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">do_something_patch</span><span class="p">:</span>
</span>             <span class="n">resp</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/ping/&#39;</span><span class="p">)</span>

             <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span> <span class="s1">&#39;pong&#39;</span><span class="p">)</span>

             <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">do_something_patch</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>

     <span class="nd">@unittest_run_loop</span>
<span class="hll">     <span class="nd">@async_patch</span><span class="p">(</span><span class="s1">&#39;tests.do_something&#39;</span><span class="p">)</span>
</span>     <span class="n">async</span> <span class="k">def</span> <span class="nf">test_ping_mocked_do_something_decorated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">do_something_patch</span><span class="p">):</span>
         <span class="n">resp</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/ping/&#39;</span><span class="p">)</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span> <span class="s1">&#39;pong&#39;</span><span class="p">)</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">do_something_patch</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="faking-request-object">
<h2>Faking request object<a class="headerlink" href="#faking-request-object" title="Permalink to this headline">¶</a></h2>
<p>aiohttp provides test utility for creating fake
<a class="reference internal" href="web_reference.html#aiohttp.web.Request" title="aiohttp.web.Request"><code class="xref py py-class docutils literal notranslate"><span class="pre">aiohttp.web.Request</span></code></a> objects:
<a class="reference internal" href="#aiohttp.test_utils.make_mocked_request" title="aiohttp.test_utils.make_mocked_request"><code class="xref py py-func docutils literal notranslate"><span class="pre">aiohttp.test_utils.make_mocked_request()</span></code></a>, it could be useful in
case of simple unit tests, like handler tests, or simulate error
conditions that hard to reproduce on real server:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">aiohttp</span> <span class="k">import</span> <span class="n">web</span>
<span class="kn">from</span> <span class="nn">aiohttp.test_utils</span> <span class="k">import</span> <span class="n">make_mocked_request</span>

<span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span>
    <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_handler</span><span class="p">():</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">make_mocked_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="s1">&#39;x&#39;</span><span class="p">})</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">body</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;data&#39;</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>We don’t recommend to apply
<a class="reference internal" href="#aiohttp.test_utils.make_mocked_request" title="aiohttp.test_utils.make_mocked_request"><code class="xref py py-func docutils literal notranslate"><span class="pre">make_mocked_request()</span></code></a> everywhere for
testing web-handler’s business object – please use test client and
real networking via ‘localhost’ as shown in examples before.</p>
<p class="last"><a class="reference internal" href="#aiohttp.test_utils.make_mocked_request" title="aiohttp.test_utils.make_mocked_request"><code class="xref py py-func docutils literal notranslate"><span class="pre">make_mocked_request()</span></code></a> exists only for
testing complex cases (e.g. emulating network errors) which
are extremely hard or even impossible to test by conventional
way.</p>
</div>
<dl class="function">
<dt id="aiohttp.test_utils.make_mocked_request">
<code class="descclassname">aiohttp.test_utils.</code><code class="descname">make_mocked_request</code><span class="sig-paren">(</span><em>method</em>, <em>path</em>, <em>headers=None</em>, <em>*</em>, <em>version=HttpVersion(1</em>, <em>1)</em>, <em>closing=False</em>, <em>app=None</em>, <em>match_info=sentinel</em>, <em>reader=sentinel</em>, <em>writer=sentinel</em>, <em>transport=sentinel</em>, <em>payload=sentinel</em>, <em>sslcontext=None</em>, <em>loop=...</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/aiohttp/test_utils.html#make_mocked_request"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#aiohttp.test_utils.make_mocked_request" title="Permalink to this definition">¶</a></dt>
<dd><p>Creates mocked web.Request testing purposes.</p>
<p>Useful in unit tests, when spinning full web server is overkill or
specific conditions and errors are hard to trigger.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>method</strong> (<em>str</em>) – str, that represents HTTP method, like; GET, POST.</li>
<li><strong>path</strong> (<em>str</em>) – str, The URL including <em>PATH INFO</em> without the host or scheme</li>
<li><strong>headers</strong> (<em>dict</em><em>, </em><em>multidict.CIMultiDict</em><em>, </em><em>list of pairs</em>) – mapping containing the headers. Can be anything accepted
by the multidict.CIMultiDict constructor.</li>
<li><strong>match_info</strong> (<em>dict</em>) – mapping containing the info to match with url parameters.</li>
<li><strong>version</strong> (<em>aiohttp.protocol.HttpVersion</em>) – namedtuple with encoded HTTP version</li>
<li><strong>closing</strong> (<em>bool</em>) – flag indicates that connection should be closed after
response.</li>
<li><strong>app</strong> (<a class="reference internal" href="web_reference.html#aiohttp.web.Application" title="aiohttp.web.Application"><em>aiohttp.web.Application</em></a>) – the aiohttp.web application attached for fake request</li>
<li><strong>writer</strong> (<em>aiohttp.StreamWriter</em>) – object for managing outcoming data</li>
<li><strong>transport</strong> (<em>asyncio.transports.Transport</em>) – asyncio transport instance</li>
<li><strong>payload</strong> (<a class="reference internal" href="streams.html#aiohttp.StreamReader" title="aiohttp.StreamReader"><em>aiohttp.StreamReader</em></a>) – raw payload reader object</li>
<li><strong>sslcontext</strong> (<em>ssl.SSLContext</em>) – ssl.SSLContext object, for HTTPS connection</li>
<li><strong>loop</strong> (<code class="xref py py-class docutils literal notranslate"><span class="pre">asyncio.AbstractEventLoop</span></code>) – An event loop instance, mocked loop by default.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last"><a class="reference internal" href="web_reference.html#aiohttp.web.Request" title="aiohttp.web.Request"><code class="xref py py-class docutils literal notranslate"><span class="pre">aiohttp.web.Request</span></code></a> object.</p>
</td>
</tr>
</tbody>
</table>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.3: </span><em>match_info</em> parameter.</p>
</div>
</dd></dl>

<div class="section" id="framework-agnostic-utilities">
<span id="aiohttp-testing-framework-agnostic-utilities"></span><span id="aiohttp-testing-writing-testable-services"></span><h3>Framework Agnostic Utilities<a class="headerlink" href="#framework-agnostic-utilities" title="Permalink to this headline">¶</a></h3>
<p>High level test creation:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">aiohttp.test_utils</span> <span class="k">import</span> <span class="n">TestClient</span><span class="p">,</span> <span class="n">TestServer</span><span class="p">,</span> <span class="n">loop_context</span>
<span class="kn">from</span> <span class="nn">aiohttp</span> <span class="k">import</span> <span class="n">request</span>

<span class="c1"># loop_context is provided as a utility. You can use any</span>
<span class="c1"># asyncio.BaseEventLoop class in its place.</span>
<span class="k">with</span> <span class="n">loop_context</span><span class="p">()</span> <span class="k">as</span> <span class="n">loop</span><span class="p">:</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">_create_example_app</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">TestServer</span><span class="p">(</span><span class="n">app</span><span class="p">),</span> <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">test_get_route</span><span class="p">():</span>
            <span class="k">nonlocal</span> <span class="n">client</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span>
            <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
            <span class="k">assert</span> <span class="s2">&quot;Hello, world&quot;</span> <span class="ow">in</span> <span class="n">text</span>

        <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">test_get_route</span><span class="p">())</span>
</pre></div>
</div>
<p>If it’s preferred to handle the creation / teardown on a more granular
basis, the TestClient object can be used directly:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">aiohttp.test_utils</span> <span class="k">import</span> <span class="n">TestClient</span><span class="p">,</span> <span class="n">TestServer</span>

<span class="k">with</span> <span class="n">loop_context</span><span class="p">()</span> <span class="k">as</span> <span class="n">loop</span><span class="p">:</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">_create_example_app</span><span class="p">()</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">TestServer</span><span class="p">(</span><span class="n">app</span><span class="p">),</span> <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">)</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">start_server</span><span class="p">())</span>
    <span class="n">root</span> <span class="o">=</span> <span class="s2">&quot;http://127.0.0.1:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">test_get_route</span><span class="p">():</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span>
        <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
        <span class="k">assert</span> <span class="s2">&quot;Hello, world&quot;</span> <span class="ow">in</span> <span class="n">text</span>

    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">test_get_route</span><span class="p">())</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">())</span>
</pre></div>
</div>
<p>A full list of the utilities provided can be found at the
<a class="reference internal" href="#module-aiohttp.test_utils" title="aiohttp.test_utils"><code class="xref py py-data docutils literal notranslate"><span class="pre">api</span> <span class="pre">reference</span></code></a></p>
</div>
</div>
<div class="section" id="testing-api-reference">
<h2>Testing API Reference<a class="headerlink" href="#testing-api-reference" title="Permalink to this headline">¶</a></h2>
<div class="section" id="test-server">
<h3>Test server<a class="headerlink" href="#test-server" title="Permalink to this headline">¶</a></h3>
<p>Runs given <a class="reference internal" href="web_reference.html#aiohttp.web.Application" title="aiohttp.web.Application"><code class="xref py py-class docutils literal notranslate"><span class="pre">aiohttp.web.Application</span></code></a> instance on random TCP port.</p>
<p>After creation the server is not started yet, use
<code class="xref py py-meth docutils literal notranslate"><span class="pre">start_server()</span></code> for actual server
starting and <code class="xref py py-meth docutils literal notranslate"><span class="pre">close()</span></code> for
stopping/cleanup.</p>
<p>Test server usually works in conjunction with
<a class="reference internal" href="#aiohttp.test_utils.TestClient" title="aiohttp.test_utils.TestClient"><code class="xref py py-class docutils literal notranslate"><span class="pre">aiohttp.test_utils.TestClient</span></code></a> which provides handy client methods
for accessing to the server.</p>
<dl class="class">
<dt id="aiohttp.test_utils.BaseTestServer">
<em class="property">class </em><code class="descclassname">aiohttp.test_utils.</code><code class="descname">BaseTestServer</code><span class="sig-paren">(</span><em>*</em>, <em>scheme='http'</em>, <em>host='127.0.0.1'</em>, <em>port=None</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/aiohttp/test_utils.html#BaseTestServer"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#aiohttp.test_utils.BaseTestServer" title="Permalink to this definition">¶</a></dt>
<dd><p>Base class for test servers.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>scheme</strong> (<em>str</em>) – HTTP scheme, non-protected <code class="docutils literal notranslate"><span class="pre">&quot;http&quot;</span></code> by default.</li>
<li><strong>host</strong> (<em>str</em>) – a host for TCP socket, IPv4 <em>local host</em>
(<code class="docutils literal notranslate"><span class="pre">'127.0.0.1'</span></code>) by default.</li>
<li><strong>port</strong> (<em>int</em>) – <p>optional port for TCP socket, if not provided a
random unused port is used.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 3.0.</span></p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<dl class="attribute">
<dt id="aiohttp.test_utils.BaseTestServer.scheme">
<code class="descname">scheme</code><a class="headerlink" href="#aiohttp.test_utils.BaseTestServer.scheme" title="Permalink to this definition">¶</a></dt>
<dd><p>A <em>scheme</em> for tested application, <code class="docutils literal notranslate"><span class="pre">'http'</span></code> for non-protected
run and <code class="docutils literal notranslate"><span class="pre">'https'</span></code> for TLS encrypted server.</p>
</dd></dl>

<dl class="attribute">
<dt id="aiohttp.test_utils.BaseTestServer.host">
<code class="descname">host</code><a class="headerlink" href="#aiohttp.test_utils.BaseTestServer.host" title="Permalink to this definition">¶</a></dt>
<dd><p><em>host</em> used to start a test server.</p>
</dd></dl>

<dl class="attribute">
<dt id="aiohttp.test_utils.BaseTestServer.port">
<code class="descname">port</code><a class="headerlink" href="#aiohttp.test_utils.BaseTestServer.port" title="Permalink to this definition">¶</a></dt>
<dd><p><em>port</em> used to start the test server.</p>
</dd></dl>

<dl class="attribute">
<dt id="aiohttp.test_utils.BaseTestServer.handler">
<code class="descname">handler</code><a class="headerlink" href="#aiohttp.test_utils.BaseTestServer.handler" title="Permalink to this definition">¶</a></dt>
<dd><p><code class="xref py py-class docutils literal notranslate"><span class="pre">aiohttp.web.WebServer</span></code> used for HTTP requests serving.</p>
</dd></dl>

<dl class="attribute">
<dt id="aiohttp.test_utils.BaseTestServer.server">
<code class="descname">server</code><a class="headerlink" href="#aiohttp.test_utils.BaseTestServer.server" title="Permalink to this definition">¶</a></dt>
<dd><p><code class="xref py py-class docutils literal notranslate"><span class="pre">asyncio.AbstractServer</span></code> used for managing accepted connections.</p>
</dd></dl>

<dl class="method">
<dt id="aiohttp.test_utils.BaseTestServer.make_url">
<code class="descname">make_url</code><span class="sig-paren">(</span><em>path</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/aiohttp/test_utils.html#BaseTestServer.make_url"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#aiohttp.test_utils.BaseTestServer.make_url" title="Permalink to this definition">¶</a></dt>
<dd><p>Return an <em>absolute</em> <code class="xref py py-class docutils literal notranslate"><span class="pre">URL</span></code> for given <em>path</em>.</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="aiohttp.test_utils.RawTestServer">
<em class="property">class </em><code class="descclassname">aiohttp.test_utils.</code><code class="descname">RawTestServer</code><span class="sig-paren">(</span><em>handler</em>, <em>*</em>, <em>scheme=&quot;http&quot;</em>, <em>host='127.0.0.1'</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/aiohttp/test_utils.html#RawTestServer"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#aiohttp.test_utils.RawTestServer" title="Permalink to this definition">¶</a></dt>
<dd><p>Low-level test server (derived from <a class="reference internal" href="#aiohttp.test_utils.BaseTestServer" title="aiohttp.test_utils.BaseTestServer"><code class="xref py py-class docutils literal notranslate"><span class="pre">BaseTestServer</span></code></a>).</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>handler</strong> – <p>a coroutine for handling web requests. The
handler should accept
<a class="reference internal" href="web_reference.html#aiohttp.web.BaseRequest" title="aiohttp.web.BaseRequest"><code class="xref py py-class docutils literal notranslate"><span class="pre">aiohttp.web.BaseRequest</span></code></a> and return a
response instance,
e.g. <a class="reference internal" href="web_reference.html#aiohttp.web.StreamResponse" title="aiohttp.web.StreamResponse"><code class="xref py py-class docutils literal notranslate"><span class="pre">StreamResponse</span></code></a> or
<a class="reference internal" href="web_reference.html#aiohttp.web.Response" title="aiohttp.web.Response"><code class="xref py py-class docutils literal notranslate"><span class="pre">Response</span></code></a>.</p>
<p>The handler could raise
<a class="reference internal" href="web_exceptions.html#aiohttp.web.HTTPException" title="aiohttp.web.HTTPException"><code class="xref py py-class docutils literal notranslate"><span class="pre">HTTPException</span></code></a> as a signal for
non-200 HTTP response.</p>
</li>
<li><strong>scheme</strong> (<em>str</em>) – HTTP scheme, non-protected <code class="docutils literal notranslate"><span class="pre">&quot;http&quot;</span></code> by default.</li>
<li><strong>host</strong> (<em>str</em>) – a host for TCP socket, IPv4 <em>local host</em>
(<code class="docutils literal notranslate"><span class="pre">'127.0.0.1'</span></code>) by default.</li>
<li><strong>port</strong> (<em>int</em>) – <p>optional port for TCP socket, if not provided a
random unused port is used.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 3.0.</span></p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="class">
<dt id="aiohttp.test_utils.TestServer">
<em class="property">class </em><code class="descclassname">aiohttp.test_utils.</code><code class="descname">TestServer</code><span class="sig-paren">(</span><em>app</em>, <em>*</em>, <em>scheme=&quot;http&quot;</em>, <em>host='127.0.0.1'</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/aiohttp/test_utils.html#TestServer"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#aiohttp.test_utils.TestServer" title="Permalink to this definition">¶</a></dt>
<dd><p>Test server (derived from <a class="reference internal" href="#aiohttp.test_utils.BaseTestServer" title="aiohttp.test_utils.BaseTestServer"><code class="xref py py-class docutils literal notranslate"><span class="pre">BaseTestServer</span></code></a>) for starting
<a class="reference internal" href="web_reference.html#aiohttp.web.Application" title="aiohttp.web.Application"><code class="xref py py-class docutils literal notranslate"><span class="pre">Application</span></code></a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>app</strong> – <a class="reference internal" href="web_reference.html#aiohttp.web.Application" title="aiohttp.web.Application"><code class="xref py py-class docutils literal notranslate"><span class="pre">aiohttp.web.Application</span></code></a> instance to run.</li>
<li><strong>scheme</strong> (<em>str</em>) – HTTP scheme, non-protected <code class="docutils literal notranslate"><span class="pre">&quot;http&quot;</span></code> by default.</li>
<li><strong>host</strong> (<em>str</em>) – a host for TCP socket, IPv4 <em>local host</em>
(<code class="docutils literal notranslate"><span class="pre">'127.0.0.1'</span></code>) by default.</li>
<li><strong>port</strong> (<em>int</em>) – <p>optional port for TCP socket, if not provided a
random unused port is used.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 3.0.</span></p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<dl class="attribute">
<dt id="aiohttp.test_utils.TestServer.app">
<code class="descname">app</code><a class="headerlink" href="#aiohttp.test_utils.TestServer.app" title="Permalink to this definition">¶</a></dt>
<dd><p><a class="reference internal" href="web_reference.html#aiohttp.web.Application" title="aiohttp.web.Application"><code class="xref py py-class docutils literal notranslate"><span class="pre">aiohttp.web.Application</span></code></a> instance to run.</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="test-client">
<h3>Test Client<a class="headerlink" href="#test-client" title="Permalink to this headline">¶</a></h3>
<dl class="class">
<dt id="aiohttp.test_utils.TestClient">
<em class="property">class </em><code class="descclassname">aiohttp.test_utils.</code><code class="descname">TestClient</code><span class="sig-paren">(</span><em>app_or_server</em>, <em>*</em>, <em>scheme='http'</em>, <em>host='127.0.0.1'</em>, <em>cookie_jar=None</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/aiohttp/test_utils.html#TestClient"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#aiohttp.test_utils.TestClient" title="Permalink to this definition">¶</a></dt>
<dd><p>A test client used for making calls to tested server.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>app_or_server</strong> – <p><a class="reference internal" href="#aiohttp.test_utils.BaseTestServer" title="aiohttp.test_utils.BaseTestServer"><code class="xref py py-class docutils literal notranslate"><span class="pre">BaseTestServer</span></code></a> instance for making
client requests to it.</p>
<p>In order to pass an <a class="reference internal" href="web_reference.html#aiohttp.web.Application" title="aiohttp.web.Application"><code class="xref py py-class docutils literal notranslate"><span class="pre">aiohttp.web.Application</span></code></a>
you need to convert it first to <a class="reference internal" href="#aiohttp.test_utils.TestServer" title="aiohttp.test_utils.TestServer"><code class="xref py py-class docutils literal notranslate"><span class="pre">TestServer</span></code></a>
first with <code class="docutils literal notranslate"><span class="pre">TestServer(app)</span></code>.</p>
</li>
<li><strong>cookie_jar</strong> – an optional <a class="reference internal" href="client_reference.html#aiohttp.CookieJar" title="aiohttp.CookieJar"><code class="xref py py-class docutils literal notranslate"><span class="pre">aiohttp.CookieJar</span></code></a> instance,
may be useful with <code class="docutils literal notranslate"><span class="pre">CookieJar(unsafe=True)</span></code>
option.</li>
<li><strong>scheme</strong> (<em>str</em>) – HTTP scheme, non-protected <code class="docutils literal notranslate"><span class="pre">&quot;http&quot;</span></code> by default.</li>
<li><strong>host</strong> (<em>str</em>) – a host for TCP socket, IPv4 <em>local host</em>
(<code class="docutils literal notranslate"><span class="pre">'127.0.0.1'</span></code>) by default.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<dl class="attribute">
<dt id="aiohttp.test_utils.TestClient.scheme">
<code class="descname">scheme</code><a class="headerlink" href="#aiohttp.test_utils.TestClient.scheme" title="Permalink to this definition">¶</a></dt>
<dd><p>A <em>scheme</em> for tested application, <code class="docutils literal notranslate"><span class="pre">'http'</span></code> for non-protected
run and <code class="docutils literal notranslate"><span class="pre">'https'</span></code> for TLS encrypted server.</p>
</dd></dl>

<dl class="attribute">
<dt id="aiohttp.test_utils.TestClient.host">
<code class="descname">host</code><a class="headerlink" href="#aiohttp.test_utils.TestClient.host" title="Permalink to this definition">¶</a></dt>
<dd><p><em>host</em> used to start a test server.</p>
</dd></dl>

<dl class="attribute">
<dt id="aiohttp.test_utils.TestClient.port">
<code class="descname">port</code><a class="headerlink" href="#aiohttp.test_utils.TestClient.port" title="Permalink to this definition">¶</a></dt>
<dd><p><em>port</em> used to start the server</p>
</dd></dl>

<dl class="attribute">
<dt id="aiohttp.test_utils.TestClient.server">
<code class="descname">server</code><a class="headerlink" href="#aiohttp.test_utils.TestClient.server" title="Permalink to this definition">¶</a></dt>
<dd><p><a class="reference internal" href="#aiohttp.test_utils.BaseTestServer" title="aiohttp.test_utils.BaseTestServer"><code class="xref py py-class docutils literal notranslate"><span class="pre">BaseTestServer</span></code></a> test server instance used in conjunction
with client.</p>
</dd></dl>

<dl class="attribute">
<dt id="aiohttp.test_utils.TestClient.app">
<code class="descname">app</code><a class="headerlink" href="#aiohttp.test_utils.TestClient.app" title="Permalink to this definition">¶</a></dt>
<dd><p>An alias for <code class="xref py py-attr docutils literal notranslate"><span class="pre">self.server.app</span></code>. return <code class="docutils literal notranslate"><span class="pre">None</span></code> if
<code class="docutils literal notranslate"><span class="pre">self.server</span></code> is not <a class="reference internal" href="#aiohttp.test_utils.TestServer" title="aiohttp.test_utils.TestServer"><code class="xref py py-class docutils literal notranslate"><span class="pre">TestServer</span></code></a>
instance(e.g. <a class="reference internal" href="#aiohttp.test_utils.RawTestServer" title="aiohttp.test_utils.RawTestServer"><code class="xref py py-class docutils literal notranslate"><span class="pre">RawTestServer</span></code></a> instance for test low-level server).</p>
</dd></dl>

<dl class="attribute">
<dt id="aiohttp.test_utils.TestClient.session">
<code class="descname">session</code><a class="headerlink" href="#aiohttp.test_utils.TestClient.session" title="Permalink to this definition">¶</a></dt>
<dd><p>An internal <code class="xref py py-class docutils literal notranslate"><span class="pre">aiohttp.ClientSession</span></code>.</p>
<p>Unlike the methods on the <a class="reference internal" href="#aiohttp.test_utils.TestClient" title="aiohttp.test_utils.TestClient"><code class="xref py py-class docutils literal notranslate"><span class="pre">TestClient</span></code></a>, client session
requests do not automatically include the host in the url
queried, and will require an absolute path to the resource.</p>
</dd></dl>

<dl class="method">
<dt id="aiohttp.test_utils.TestClient.make_url">
<code class="descname">make_url</code><span class="sig-paren">(</span><em>path</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/aiohttp/test_utils.html#TestClient.make_url"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#aiohttp.test_utils.TestClient.make_url" title="Permalink to this definition">¶</a></dt>
<dd><p>Return an <em>absolute</em> <code class="xref py py-class docutils literal notranslate"><span class="pre">URL</span></code> for given <em>path</em>.</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="utilities">
<h3>Utilities<a class="headerlink" href="#utilities" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="aiohttp.test_utils.make_mocked_coro">
<code class="descclassname">aiohttp.test_utils.</code><code class="descname">make_mocked_coro</code><span class="sig-paren">(</span><em>return_value</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/aiohttp/test_utils.html#make_mocked_coro"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#aiohttp.test_utils.make_mocked_coro" title="Permalink to this definition">¶</a></dt>
<dd><p>Creates a coroutine mock.</p>
<p>Behaves like a coroutine which returns <em>return_value</em>.  But it is
also a mock object, you might test it as usual
<code class="xref py py-class docutils literal notranslate"><span class="pre">Mock</span></code>:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">mocked</span> <span class="o">=</span> <span class="n">make_mocked_coro</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">assert</span> <span class="mi">1</span> <span class="o">==</span> <span class="k">await</span> <span class="n">mocked</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">mocked</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>return_value</strong> – A value that the the mock object will return when
called.</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">A mock object that behaves as a coroutine which returns
<em>return_value</em> when called.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="aiohttp.test_utils.unused_port">
<code class="descclassname">aiohttp.test_utils.</code><code class="descname">unused_port</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/aiohttp/test_utils.html#unused_port"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#aiohttp.test_utils.unused_port" title="Permalink to this definition">¶</a></dt>
<dd><p>Return an unused port number for IPv4 TCP protocol.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return int:</th><td class="field-body">ephemeral port number which could be reused by test server.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="aiohttp.test_utils.loop_context">
<code class="descclassname">aiohttp.test_utils.</code><code class="descname">loop_context</code><span class="sig-paren">(</span><em>loop_factory=&lt;function asyncio.new_event_loop&gt;</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/aiohttp/test_utils.html#loop_context"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#aiohttp.test_utils.loop_context" title="Permalink to this definition">¶</a></dt>
<dd><p>A contextmanager that creates an event_loop, for test purposes.</p>
<p>Handles the creation and cleanup of a test loop.</p>
</dd></dl>

<dl class="function">
<dt id="aiohttp.test_utils.setup_test_loop">
<code class="descclassname">aiohttp.test_utils.</code><code class="descname">setup_test_loop</code><span class="sig-paren">(</span><em>loop_factory=&lt;function asyncio.new_event_loop&gt;</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/aiohttp/test_utils.html#setup_test_loop"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#aiohttp.test_utils.setup_test_loop" title="Permalink to this definition">¶</a></dt>
<dd><p>Create and return an <code class="xref py py-class docutils literal notranslate"><span class="pre">asyncio.AbstractEventLoop</span></code> instance.</p>
<p>The caller should also call teardown_test_loop, once they are done
with the loop.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>As side effect the function changes asyncio <em>default loop</em> by
<code class="xref py py-func docutils literal notranslate"><span class="pre">asyncio.set_event_loop()</span></code> call.</p>
<p>Previous default loop is not restored.</p>
<p class="last">It should not be a problem for test suite: every test expects a
new test loop instance anyway.</p>
</div>
<div class="versionchanged">
<p><span class="versionmodified">Changed in version 3.1: </span>The function installs a created event loop as <em>default</em>.</p>
</div>
</dd></dl>

<dl class="function">
<dt id="aiohttp.test_utils.teardown_test_loop">
<code class="descclassname">aiohttp.test_utils.</code><code class="descname">teardown_test_loop</code><span class="sig-paren">(</span><em>loop</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/aiohttp/test_utils.html#teardown_test_loop"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#aiohttp.test_utils.teardown_test_loop" title="Permalink to this definition">¶</a></dt>
<dd><p>Teardown and cleanup an event_loop created by setup_test_loop.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>loop</strong> (<em>asyncio.AbstractEventLoop</em>) – the loop to teardown</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/teanga-logo.svg" alt="Logo"/>
    
  </a>
</p>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=pret-a-llod&repo=teanga&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../create_workflow.html">How to create a workflow in Teanga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../run_workflow.html">How to run a workflow in Teanga</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, teanga maintainers.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/examples/testing.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    
    <a href="https://github.com/pret-a-llod/teanga" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>